{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "879a0e1b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:47:52.411860Z",
     "iopub.status.busy": "2024-08-05T01:47:52.411488Z",
     "iopub.status.idle": "2024-08-05T01:48:08.528197Z",
     "shell.execute_reply": "2024-08-05T01:48:08.527046Z"
    },
    "papermill": {
     "duration": 16.127107,
     "end_time": "2024-08-05T01:48:08.530456",
     "exception": false,
     "start_time": "2024-08-05T01:47:52.403349",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING: Logging before InitGoogle() is written to STDERR\n",
      "E0000 00:00:1722822479.108666      77 common_lib.cc:798] Could not set metric server port: INVALID_ARGUMENT: Could not find SliceBuilder port 8471 in any of the 0 ports provided in `tpu_process_addresses`=\"local\"\n",
      "=== Source Location Trace: === \n",
      "learning/45eac/tfrc/runtime/common_lib.cc:479\n",
      "D0805 01:47:59.117079274      77 config.cc:196]                        gRPC EXPERIMENT call_status_override_on_cancellation   OFF (default:OFF)\n",
      "D0805 01:47:59.117093909      77 config.cc:196]                        gRPC EXPERIMENT call_v3                                OFF (default:OFF)\n",
      "D0805 01:47:59.117097242      77 config.cc:196]                        gRPC EXPERIMENT canary_client_privacy                  ON  (default:ON)\n",
      "D0805 01:47:59.117099824      77 config.cc:196]                        gRPC EXPERIMENT capture_base_context                   ON  (default:ON)\n",
      "D0805 01:47:59.117102287      77 config.cc:196]                        gRPC EXPERIMENT client_idleness                        ON  (default:ON)\n",
      "D0805 01:47:59.117104616      77 config.cc:196]                        gRPC EXPERIMENT client_privacy                         ON  (default:ON)\n",
      "D0805 01:47:59.117106938      77 config.cc:196]                        gRPC EXPERIMENT dapper_request_wire_size               OFF (default:OFF)\n",
      "D0805 01:47:59.117109252      77 config.cc:196]                        gRPC EXPERIMENT empty_experiment                       OFF (default:OFF)\n",
      "D0805 01:47:59.117111474      77 config.cc:196]                        gRPC EXPERIMENT event_engine_client                    OFF (default:OFF)\n",
      "D0805 01:47:59.117113664      77 config.cc:196]                        gRPC EXPERIMENT event_engine_dns                       ON  (default:ON)\n",
      "D0805 01:47:59.117115894      77 config.cc:196]                        gRPC EXPERIMENT event_engine_listener                  ON  (default:ON)\n",
      "D0805 01:47:59.117118113      77 config.cc:196]                        gRPC EXPERIMENT free_large_allocator                   OFF (default:OFF)\n",
      "D0805 01:47:59.117120319      77 config.cc:196]                        gRPC EXPERIMENT google_no_envelope_resolver            OFF (default:OFF)\n",
      "D0805 01:47:59.117122509      77 config.cc:196]                        gRPC EXPERIMENT http2_stats_fix                        OFF (default:OFF)\n",
      "D0805 01:47:59.117124687      77 config.cc:196]                        gRPC EXPERIMENT keepalive_fix                          OFF (default:OFF)\n",
      "D0805 01:47:59.117126889      77 config.cc:196]                        gRPC EXPERIMENT keepalive_server_fix                   ON  (default:ON)\n",
      "D0805 01:47:59.117129234      77 config.cc:196]                        gRPC EXPERIMENT loas_do_not_prefer_rekey_next_protocol OFF (default:OFF)\n",
      "D0805 01:47:59.117131460      77 config.cc:196]                        gRPC EXPERIMENT loas_prod_to_cloud_prefer_pfs_ciphers  OFF (default:OFF)\n",
      "D0805 01:47:59.117133669      77 config.cc:196]                        gRPC EXPERIMENT monitoring_experiment                  ON  (default:ON)\n",
      "D0805 01:47:59.117135945      77 config.cc:196]                        gRPC EXPERIMENT multiping                              OFF (default:OFF)\n",
      "D0805 01:47:59.117138149      77 config.cc:196]                        gRPC EXPERIMENT peer_state_based_framing               OFF (default:OFF)\n",
      "D0805 01:47:59.117140363      77 config.cc:196]                        gRPC EXPERIMENT pending_queue_cap                      ON  (default:ON)\n",
      "D0805 01:47:59.117142669      77 config.cc:196]                        gRPC EXPERIMENT pick_first_happy_eyeballs              ON  (default:ON)\n",
      "D0805 01:47:59.117144895      77 config.cc:196]                        gRPC EXPERIMENT promise_based_client_call              OFF (default:OFF)\n",
      "D0805 01:47:59.117147037      77 config.cc:196]                        gRPC EXPERIMENT promise_based_inproc_transport         OFF (default:OFF)\n",
      "D0805 01:47:59.117149190      77 config.cc:196]                        gRPC EXPERIMENT promise_based_server_call              OFF (default:OFF)\n",
      "D0805 01:47:59.117151465      77 config.cc:196]                        gRPC EXPERIMENT registered_method_lookup_in_transport  ON  (default:ON)\n",
      "D0805 01:47:59.117153702      77 config.cc:196]                        gRPC EXPERIMENT rfc_max_concurrent_streams             ON  (default:ON)\n",
      "D0805 01:47:59.117156027      77 config.cc:196]                        gRPC EXPERIMENT round_robin_delegate_to_pick_first     ON  (default:ON)\n",
      "D0805 01:47:59.117159173      77 config.cc:196]                        gRPC EXPERIMENT rstpit                                 OFF (default:OFF)\n",
      "D0805 01:47:59.117161458      77 config.cc:196]                        gRPC EXPERIMENT schedule_cancellation_over_write       OFF (default:OFF)\n",
      "D0805 01:47:59.117163702      77 config.cc:196]                        gRPC EXPERIMENT server_privacy                         ON  (default:ON)\n",
      "D0805 01:47:59.117166230      77 config.cc:196]                        gRPC EXPERIMENT tcp_frame_size_tuning                  OFF (default:OFF)\n",
      "D0805 01:47:59.117168447      77 config.cc:196]                        gRPC EXPERIMENT tcp_rcv_lowat                          OFF (default:OFF)\n",
      "D0805 01:47:59.117170617      77 config.cc:196]                        gRPC EXPERIMENT trace_record_callops                   OFF (default:OFF)\n",
      "D0805 01:47:59.117172812      77 config.cc:196]                        gRPC EXPERIMENT unconstrained_max_quota_buffer_size    OFF (default:OFF)\n",
      "D0805 01:47:59.117174930      77 config.cc:196]                        gRPC EXPERIMENT v3_backend_metric_filter               OFF (default:OFF)\n",
      "D0805 01:47:59.117177100      77 config.cc:196]                        gRPC EXPERIMENT v3_channel_idle_filters                ON  (default:ON)\n",
      "D0805 01:47:59.117179351      77 config.cc:196]                        gRPC EXPERIMENT v3_compression_filter                  ON  (default:ON)\n",
      "D0805 01:47:59.117181557      77 config.cc:196]                        gRPC EXPERIMENT v3_server_auth_filter                  OFF (default:OFF)\n",
      "D0805 01:47:59.117183745      77 config.cc:196]                        gRPC EXPERIMENT work_serializer_clears_time_cache      OFF (default:OFF)\n",
      "D0805 01:47:59.117185897      77 config.cc:196]                        gRPC EXPERIMENT work_serializer_dispatch               OFF (default:OFF)\n",
      "D0805 01:47:59.117188099      77 config.cc:196]                        gRPC EXPERIMENT write_size_cap                         ON  (default:ON)\n",
      "D0805 01:47:59.117190325      77 config.cc:196]                        gRPC EXPERIMENT write_size_policy                      ON  (default:ON)\n",
      "D0805 01:47:59.117192574      77 config.cc:196]                        gRPC EXPERIMENT wrr_delegate_to_pick_first             ON  (default:ON)\n",
      "I0805 01:47:59.117370379      77 ev_epoll1_linux.cc:123]               grpc epoll fd: 56\n",
      "D0805 01:47:59.117381530      77 ev_posix.cc:113]                      Using polling engine: epoll1\n",
      "D0805 01:47:59.129689488      77 lb_policy_registry.cc:46]             registering LB policy factory for \"priority_experimental\"\n",
      "D0805 01:47:59.129699469      77 lb_policy_registry.cc:46]             registering LB policy factory for \"outlier_detection_experimental\"\n",
      "D0805 01:47:59.129707601      77 lb_policy_registry.cc:46]             registering LB policy factory for \"weighted_target_experimental\"\n",
      "D0805 01:47:59.129710857      77 lb_policy_registry.cc:46]             registering LB policy factory for \"pick_first\"\n",
      "D0805 01:47:59.129714000      77 lb_policy_registry.cc:46]             registering LB policy factory for \"round_robin\"\n",
      "D0805 01:47:59.129716864      77 lb_policy_registry.cc:46]             registering LB policy factory for \"weighted_round_robin\"\n",
      "D0805 01:47:59.129760660      77 lb_policy_registry.cc:46]             registering LB policy factory for \"grpclb\"\n",
      "D0805 01:47:59.129775224      77 dns_resolver_plugin.cc:43]            Using EventEngine dns resolver\n",
      "D0805 01:47:59.129791361      77 lb_policy_registry.cc:46]             registering LB policy factory for \"rls_experimental\"\n",
      "D0805 01:47:59.129819134      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_cluster_manager_experimental\"\n",
      "D0805 01:47:59.129827188      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_cluster_impl_experimental\"\n",
      "D0805 01:47:59.129837543      77 lb_policy_registry.cc:46]             registering LB policy factory for \"cds_experimental\"\n",
      "D0805 01:47:59.129841553      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_override_host_experimental\"\n",
      "D0805 01:47:59.129844641      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_wrr_locality_experimental\"\n",
      "D0805 01:47:59.129847524      77 lb_policy_registry.cc:46]             registering LB policy factory for \"ring_hash_experimental\"\n",
      "D0805 01:47:59.129850691      77 certificate_provider_registry.cc:33]  registering certificate provider factory for \"file_watcher\"\n",
      "D0805 01:47:59.129900698      77 channel_init.cc:157]                  Filter server-auth not registered, but is referenced in the after clause of grpc-server-authz when building channel stack SERVER_CHANNEL\n",
      "I0805 01:47:59.131532806      77 ev_epoll1_linux.cc:359]               grpc epoll fd: 58\n",
      "I0805 01:47:59.132699153      77 tcp_socket_utils.cc:689]              Disabling AF_INET6 sockets because ::1 is not available.\n",
      "I0805 01:47:59.136267207     181 socket_utils_common_posix.cc:452]     Disabling AF_INET6 sockets because ::1 is not available.\n",
      "I0805 01:47:59.136320447     181 socket_utils_common_posix.cc:379]     TCP_USER_TIMEOUT is available. TCP_USER_TIMEOUT will be used thereafter\n",
      "E0805 01:47:59.141840281     168 oauth2_credentials.cc:238]            oauth_fetch: UNKNOWN:C-ares status is not ARES_SUCCESS qtype=A name=metadata.google.internal. is_balancer=0: Domain name not found {grpc_status:2, created_time:\"2024-08-05T01:47:59.141826501+00:00\"}\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.10/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html\n",
      "  from .autonotebook import tqdm as notebook_tqdm\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import keras\n",
    "import keras_nlp\n",
    "import tensorflow as tf\n",
    "from sklearn.model_selection import train_test_split\n",
    "from matplotlib import pyplot as plt"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "88f733b4",
   "metadata": {
    "papermill": {
     "duration": 0.005448,
     "end_time": "2024-08-05T01:48:08.540410",
     "exception": false,
     "start_time": "2024-08-05T01:48:08.534962",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load Train Data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "307f41a1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:08.550793Z",
     "iopub.status.busy": "2024-08-05T01:48:08.550321Z",
     "iopub.status.idle": "2024-08-05T01:48:15.783805Z",
     "shell.execute_reply": "2024-08-05T01:48:15.783011Z"
    },
    "papermill": {
     "duration": 7.241183,
     "end_time": "2024-08-05T01:48:15.785684",
     "exception": false,
     "start_time": "2024-08-05T01:48:08.544501",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>model_a</th>\n",
       "      <th>model_b</th>\n",
       "      <th>prompt</th>\n",
       "      <th>response_a</th>\n",
       "      <th>response_b</th>\n",
       "      <th>winner_model_a</th>\n",
       "      <th>winner_model_b</th>\n",
       "      <th>winner_tie</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>30192</td>\n",
       "      <td>gpt-4-1106-preview</td>\n",
       "      <td>gpt-4-0613</td>\n",
       "      <td>Is it morally right to try to have a certain p...</td>\n",
       "      <td>The question of whether it is morally right to...</td>\n",
       "      <td>As an AI, I don't have personal beliefs or opi...</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>53567</td>\n",
       "      <td>koala-13b</td>\n",
       "      <td>gpt-4-0613</td>\n",
       "      <td>What is the difference between marriage licens...</td>\n",
       "      <td>A marriage license is a legal document that al...</td>\n",
       "      <td>A marriage license and a marriage certificate ...</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>65089</td>\n",
       "      <td>gpt-3.5-turbo-0613</td>\n",
       "      <td>mistral-medium</td>\n",
       "      <td>explain function calling. how would you call a...</td>\n",
       "      <td>Function calling is the process of invoking or...</td>\n",
       "      <td>Function calling is the process of invoking a ...</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>96401</td>\n",
       "      <td>llama-2-13b-chat</td>\n",
       "      <td>mistral-7b-instruct</td>\n",
       "      <td>How can I create a test set for a very rare ca...</td>\n",
       "      <td>Creating a test set for a very rare category c...</td>\n",
       "      <td>When building a classifier for a very rare cat...</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>198779</td>\n",
       "      <td>koala-13b</td>\n",
       "      <td>gpt-3.5-turbo-0314</td>\n",
       "      <td>What is the best way to travel from Tel-Aviv t...</td>\n",
       "      <td>The best way to travel from Tel Aviv to Jerusa...</td>\n",
       "      <td>The best way to travel from Tel-Aviv to Jerusa...</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       id             model_a              model_b  \\\n",
       "0   30192  gpt-4-1106-preview           gpt-4-0613   \n",
       "1   53567           koala-13b           gpt-4-0613   \n",
       "2   65089  gpt-3.5-turbo-0613       mistral-medium   \n",
       "3   96401    llama-2-13b-chat  mistral-7b-instruct   \n",
       "4  198779           koala-13b   gpt-3.5-turbo-0314   \n",
       "\n",
       "                                              prompt  \\\n",
       "0  Is it morally right to try to have a certain p...   \n",
       "1  What is the difference between marriage licens...   \n",
       "2  explain function calling. how would you call a...   \n",
       "3  How can I create a test set for a very rare ca...   \n",
       "4  What is the best way to travel from Tel-Aviv t...   \n",
       "\n",
       "                                          response_a  \\\n",
       "0  The question of whether it is morally right to...   \n",
       "1  A marriage license is a legal document that al...   \n",
       "2  Function calling is the process of invoking or...   \n",
       "3  Creating a test set for a very rare category c...   \n",
       "4  The best way to travel from Tel Aviv to Jerusa...   \n",
       "\n",
       "                                          response_b  winner_model_a  \\\n",
       "0  As an AI, I don't have personal beliefs or opi...               1   \n",
       "1  A marriage license and a marriage certificate ...               0   \n",
       "2  Function calling is the process of invoking a ...               0   \n",
       "3  When building a classifier for a very rare cat...               1   \n",
       "4  The best way to travel from Tel-Aviv to Jerusa...               0   \n",
       "\n",
       "   winner_model_b  winner_tie  \n",
       "0               0           0  \n",
       "1               1           0  \n",
       "2               0           1  \n",
       "3               0           0  \n",
       "4               1           0  "
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Load Kaggle Base Folder\n",
    "base_dir = '/kaggle/input/lmsys-chatbot-arena/'\n",
    "\n",
    "# Load Train Data\n",
    "df = pd.read_csv(base_dir + 'train.csv')\n",
    "\n",
    "# Parse String and Ensure all text data is encoded to UTF-8\n",
    "for col in [i for i in df.columns if i in ['prompt', 'response_a', 'response_b']]:\n",
    "    df[col] = df[col].map(lambda x: eval(x.replace(\"null\", \"''\"))[0])\n",
    "    df[col] = df[col].apply(lambda x: str(x).encode('utf-8', errors='ignore').decode('utf-8'))\n",
    "\n",
    "# Show Sample\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f8442906",
   "metadata": {
    "papermill": {
     "duration": 0.004326,
     "end_time": "2024-08-05T01:48:15.794991",
     "exception": false,
     "start_time": "2024-08-05T01:48:15.790665",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Create Label"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "19e94c2d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:15.805621Z",
     "iopub.status.busy": "2024-08-05T01:48:15.805336Z",
     "iopub.status.idle": "2024-08-05T01:48:15.823096Z",
     "shell.execute_reply": "2024-08-05T01:48:15.822378Z"
    },
    "papermill": {
     "duration": 0.024987,
     "end_time": "2024-08-05T01:48:15.824761",
     "exception": false,
     "start_time": "2024-08-05T01:48:15.799774",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Create label dictionary for mapping\n",
    "label_map = {'winner_model_a': 0, 'winner_model_b': 1, 'winner_tie': 2}\n",
    "\n",
    "# Map column into label\n",
    "df['label'] = df[['winner_model_a', 'winner_model_b', 'winner_tie']].idxmax(axis=1).map(label_map)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "af6a0b6b",
   "metadata": {
    "papermill": {
     "duration": 0.004223,
     "end_time": "2024-08-05T01:48:15.833698",
     "exception": false,
     "start_time": "2024-08-05T01:48:15.829475",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Tokenizer & Preprocessor"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "d9414bfc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:15.843854Z",
     "iopub.status.busy": "2024-08-05T01:48:15.843608Z",
     "iopub.status.idle": "2024-08-05T01:48:28.037106Z",
     "shell.execute_reply": "2024-08-05T01:48:28.036144Z"
    },
    "papermill": {
     "duration": 12.200572,
     "end_time": "2024-08-05T01:48:28.038925",
     "exception": false,
     "start_time": "2024-08-05T01:48:15.838353",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors.index.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'tokenizer.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'tokenizer.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'assets/tokenizer/vocabulary.txt' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING: All log messages before absl::InitializeLog() is called are written to STDERR\n",
      "I0000 00:00:1722822507.967500      77 service.cc:145] XLA service 0x55968a459b50 initialized for platform TPU (this does not guarantee that XLA will be used). Devices:\n",
      "I0000 00:00:1722822507.967563      77 service.cc:153]   StreamExecutor device (0): TPU, 2a886c8\n",
      "I0000 00:00:1722822507.967567      77 service.cc:153]   StreamExecutor device (1): TPU, 2a886c8\n",
      "I0000 00:00:1722822507.967571      77 service.cc:153]   StreamExecutor device (2): TPU, 2a886c8\n",
      "I0000 00:00:1722822507.967573      77 service.cc:153]   StreamExecutor device (3): TPU, 2a886c8\n",
      "I0000 00:00:1722822507.967576      77 service.cc:153]   StreamExecutor device (4): TPU, 2a886c8\n",
      "I0000 00:00:1722822507.967579      77 service.cc:153]   StreamExecutor device (5): TPU, 2a886c8\n",
      "I0000 00:00:1722822507.967582      77 service.cc:153]   StreamExecutor device (6): TPU, 2a886c8\n",
      "I0000 00:00:1722822507.967585      77 service.cc:153]   StreamExecutor device (7): TPU, 2a886c8\n"
     ]
    }
   ],
   "source": [
    "tokenizer = keras_nlp.models.BertTokenizer.from_preset(\n",
    "    \"bert_small_en_uncased\",\n",
    ")\n",
    "\n",
    "preprocessor = keras_nlp.models.BertPreprocessor(\n",
    "    tokenizer=tokenizer,\n",
    "    sequence_length=512\n",
    ")\n",
    "\n",
    "# Update preprocess_fn to handle multiple inputs and return additional features\n",
    "def preprocess_fn(prompt, response_a, response_b, label=None):\n",
    "    prompt = preprocessor(prompt)\n",
    "    response_a = preprocessor(response_a)\n",
    "    response_b = preprocessor(response_b)\n",
    "    inputs = {\n",
    "        'prompt_input': prompt['token_ids'],\n",
    "        'prompt_segment_ids': prompt['segment_ids'],\n",
    "        'prompt_padding_mask': prompt['padding_mask'],\n",
    "        'response_a_input': response_a['token_ids'],\n",
    "        'response_a_segment_ids': response_a['segment_ids'],\n",
    "        'response_a_padding_mask': response_a['padding_mask'],\n",
    "        'response_b_input': response_b['token_ids'],\n",
    "        'response_b_segment_ids': response_b['segment_ids'],\n",
    "        'response_b_padding_mask': response_b['padding_mask'],\n",
    "    }\n",
    "    return (inputs, label) if label is not None else inputs\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d1f8f98f",
   "metadata": {
    "papermill": {
     "duration": 0.005231,
     "end_time": "2024-08-05T01:48:28.049179",
     "exception": false,
     "start_time": "2024-08-05T01:48:28.043948",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Build Dataset"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "cb6dd33c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:28.060257Z",
     "iopub.status.busy": "2024-08-05T01:48:28.059984Z",
     "iopub.status.idle": "2024-08-05T01:48:28.065306Z",
     "shell.execute_reply": "2024-08-05T01:48:28.064592Z"
    },
    "papermill": {
     "duration": 0.012925,
     "end_time": "2024-08-05T01:48:28.066773",
     "exception": false,
     "start_time": "2024-08-05T01:48:28.053848",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Update build_dataset function\n",
    "def build_dataset(prompts, responses_a, responses_b, labels=None, batch_size=16, shuffle=True):\n",
    "    slices = (prompts, responses_a, responses_b, keras.utils.to_categorical(labels, num_classes=3)) if labels is not None else (prompts, responses_a, responses_b)\n",
    "    ds = tf.data.Dataset.from_tensor_slices(slices)\n",
    "    ds = ds.map(preprocess_fn, num_parallel_calls=tf.data.AUTOTUNE)\n",
    "    if shuffle:\n",
    "        ds = ds.shuffle(buffer_size=10000)\n",
    "    ds = ds.batch(batch_size)\n",
    "    ds = ds.prefetch(tf.data.AUTOTUNE)\n",
    "    return ds"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "60d8980c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:28.077936Z",
     "iopub.status.busy": "2024-08-05T01:48:28.077645Z",
     "iopub.status.idle": "2024-08-05T01:48:34.781226Z",
     "shell.execute_reply": "2024-08-05T01:48:34.780168Z"
    },
    "papermill": {
     "duration": 6.711737,
     "end_time": "2024-08-05T01:48:34.783566",
     "exception": false,
     "start_time": "2024-08-05T01:48:28.071829",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "train_df, val_df = train_test_split(df, test_size=0.2, stratify=df.label)\n",
    "\n",
    "# Build the datasets\n",
    "train_dataset = build_dataset(\n",
    "    prompts=train_df.prompt.tolist(),\n",
    "    responses_a=train_df.response_a.tolist(),\n",
    "    responses_b=train_df.response_b.tolist(),\n",
    "    labels=train_df.label.tolist(),\n",
    "    batch_size=64,\n",
    "    shuffle=True\n",
    ")\n",
    "\n",
    "val_dataset = build_dataset(\n",
    "    prompts=val_df.prompt.tolist(),\n",
    "    responses_a=val_df.response_a.tolist(),\n",
    "    responses_b=val_df.response_b.tolist(),\n",
    "    labels=val_df.label.tolist(),\n",
    "    batch_size=64,\n",
    "    shuffle=False\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6d3a7ec8",
   "metadata": {
    "papermill": {
     "duration": 0.004997,
     "end_time": "2024-08-05T01:48:34.793644",
     "exception": false,
     "start_time": "2024-08-05T01:48:34.788647",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Modeling"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "333b0254",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:34.805175Z",
     "iopub.status.busy": "2024-08-05T01:48:34.804860Z",
     "iopub.status.idle": "2024-08-05T01:48:39.454037Z",
     "shell.execute_reply": "2024-08-05T01:48:39.453078Z"
    },
    "papermill": {
     "duration": 4.660474,
     "end_time": "2024-08-05T01:48:39.458960",
     "exception": false,
     "start_time": "2024-08-05T01:48:34.798486",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Deallocate tpu buffers before initializing tpu system.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Initializing the TPU system: local\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Finished initializing TPU system.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:absl:`tf.distribute.experimental.TPUStrategy` is deprecated, please use the non-experimental symbol `tf.distribute.TPUStrategy` instead.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Found TPU system:\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Found TPU system:\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores: 8\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores: 8\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Workers: 1\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Workers: 1\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores Per Worker: 8\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores Per Worker: 8\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:CPU:0, CPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:CPU:0, CPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:0, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:0, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:1, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:1, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:2, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:2, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:3, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:3, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:4, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:4, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:5, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:5, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:6, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:6, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:7, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:7, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU_SYSTEM:0, TPU_SYSTEM, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU_SYSTEM:0, TPU_SYSTEM, 0, 0)\n"
     ]
    }
   ],
   "source": [
    "try:\n",
    "    tpu = tf.distribute.cluster_resolver.TPUClusterResolver()\n",
    "    tf.config.experimental_connect_to_cluster(tpu)\n",
    "    tf.tpu.experimental.initialize_tpu_system(tpu)\n",
    "    tpu_strategy = tf.distribute.experimental.TPUStrategy(tpu)\n",
    "except ValueError:\n",
    "    tpu_strategy = tf.distribute.get_strategy()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "33470e1d",
   "metadata": {
    "papermill": {
     "duration": 0.007285,
     "end_time": "2024-08-05T01:48:39.473279",
     "exception": false,
     "start_time": "2024-08-05T01:48:39.465994",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Train"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "6d25d348",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:39.488724Z",
     "iopub.status.busy": "2024-08-05T01:48:39.488422Z",
     "iopub.status.idle": "2024-08-05T01:48:50.538610Z",
     "shell.execute_reply": "2024-08-05T01:48:50.537756Z"
    },
    "papermill": {
     "duration": 11.060183,
     "end_time": "2024-08-05T01:48:50.540521",
     "exception": false,
     "start_time": "2024-08-05T01:48:39.480338",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors.index.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'config.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'config.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.weights.h5' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822530.105386      77 device_compiler.h:188] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">Model: \"functional\"</span>\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1mModel: \"functional\"\u001b[0m\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓\n",
       "┃<span style=\"font-weight: bold\"> Layer (type)        </span>┃<span style=\"font-weight: bold\"> Output Shape      </span>┃<span style=\"font-weight: bold\">    Param # </span>┃<span style=\"font-weight: bold\"> Connected to      </span>┃\n",
       "┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩\n",
       "│ prompt_padding_mask │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_segment_ids  │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_input        │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_padding… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_segment… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_input    │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_padding… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_segment… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_input    │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ bert_backbone       │ [(<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>),     │ <span style=\"color: #00af00; text-decoration-color: #00af00\">28,763,648</span> │ prompt_padding_m… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">BertBackbone</span>)      │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)] │            │ prompt_segment_i… │\n",
       "│                     │                   │            │ prompt_input[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">…</span> │\n",
       "│                     │                   │            │ response_a_paddi… │\n",
       "│                     │                   │            │ response_a_segme… │\n",
       "│                     │                   │            │ response_a_input… │\n",
       "│                     │                   │            │ response_b_paddi… │\n",
       "│                     │                   │            │ response_b_segme… │\n",
       "│                     │                   │            │ response_b_input… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention           │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)  │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Attention</span>)         │                   │            │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">1</span>]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention_1         │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)  │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Attention</span>)         │                   │            │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">2</span>]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ attention[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]   │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">GlobalAveragePool…</span> │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ attention_1[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>] │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">GlobalAveragePool…</span> │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ concatenate         │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">1024</span>)      │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ global_average_p… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Concatenate</span>)       │                   │            │ global_average_p… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Dense</span>)       │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">32</span>)        │     <span style=\"color: #00af00; text-decoration-color: #00af00\">32,800</span> │ concatenate[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>] │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense_1 (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Dense</span>)     │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">3</span>)         │         <span style=\"color: #00af00; text-decoration-color: #00af00\">99</span> │ dense[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]       │\n",
       "└─────────────────────┴───────────────────┴────────────┴───────────────────┘\n",
       "</pre>\n"
      ],
      "text/plain": [
       "┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓\n",
       "┃\u001b[1m \u001b[0m\u001b[1mLayer (type)       \u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1mOutput Shape     \u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1m   Param #\u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1mConnected to     \u001b[0m\u001b[1m \u001b[0m┃\n",
       "┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩\n",
       "│ prompt_padding_mask │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_segment_ids  │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_input        │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_padding… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_segment… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_input    │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_padding… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_segment… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_input    │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ bert_backbone       │ [(\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m),     │ \u001b[38;5;34m28,763,648\u001b[0m │ prompt_padding_m… │\n",
       "│ (\u001b[38;5;33mBertBackbone\u001b[0m)      │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m, \u001b[38;5;34m512\u001b[0m)] │            │ prompt_segment_i… │\n",
       "│                     │                   │            │ prompt_input[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m…\u001b[0m │\n",
       "│                     │                   │            │ response_a_paddi… │\n",
       "│                     │                   │            │ response_a_segme… │\n",
       "│                     │                   │            │ response_a_input… │\n",
       "│                     │                   │            │ response_b_paddi… │\n",
       "│                     │                   │            │ response_b_segme… │\n",
       "│                     │                   │            │ response_b_input… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention           │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m, \u001b[38;5;34m512\u001b[0m)  │          \u001b[38;5;34m0\u001b[0m │ bert_backbone[\u001b[38;5;34m0\u001b[0m]… │\n",
       "│ (\u001b[38;5;33mAttention\u001b[0m)         │                   │            │ bert_backbone[\u001b[38;5;34m1\u001b[0m]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention_1         │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m, \u001b[38;5;34m512\u001b[0m)  │          \u001b[38;5;34m0\u001b[0m │ bert_backbone[\u001b[38;5;34m0\u001b[0m]… │\n",
       "│ (\u001b[38;5;33mAttention\u001b[0m)         │                   │            │ bert_backbone[\u001b[38;5;34m2\u001b[0m]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ attention[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]   │\n",
       "│ (\u001b[38;5;33mGlobalAveragePool…\u001b[0m │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ attention_1[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m] │\n",
       "│ (\u001b[38;5;33mGlobalAveragePool…\u001b[0m │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ concatenate         │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m1024\u001b[0m)      │          \u001b[38;5;34m0\u001b[0m │ global_average_p… │\n",
       "│ (\u001b[38;5;33mConcatenate\u001b[0m)       │                   │            │ global_average_p… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense (\u001b[38;5;33mDense\u001b[0m)       │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m32\u001b[0m)        │     \u001b[38;5;34m32,800\u001b[0m │ concatenate[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m] │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense_1 (\u001b[38;5;33mDense\u001b[0m)     │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m3\u001b[0m)         │         \u001b[38;5;34m99\u001b[0m │ dense[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]       │\n",
       "└─────────────────────┴───────────────────┴────────────┴───────────────────┘\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Total params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">28,796,547</span> (109.85 MB)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Total params: \u001b[0m\u001b[38;5;34m28,796,547\u001b[0m (109.85 MB)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Trainable params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">28,796,547</span> (109.85 MB)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Trainable params: \u001b[0m\u001b[38;5;34m28,796,547\u001b[0m (109.85 MB)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Non-trainable params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> (0.00 B)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Non-trainable params: \u001b[0m\u001b[38;5;34m0\u001b[0m (0.00 B)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "with tpu_strategy.scope():\n",
    "    # Define input layers\n",
    "    prompt_input_ids = keras.Input(shape=(512,), dtype=tf.int32, name='prompt_input')\n",
    "    prompt_segment_ids = keras.Input(shape=(512,), dtype=tf.int32, name='prompt_segment_ids')\n",
    "    prompt_padding_mask = keras.Input(shape=(512,), dtype=tf.int32, name='prompt_padding_mask')\n",
    "\n",
    "    response_a_input_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_a_input')\n",
    "    response_a_segment_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_a_segment_ids')\n",
    "    response_a_padding_mask = keras.Input(shape=(512,), dtype=tf.int32, name='response_a_padding_mask')\n",
    "\n",
    "    response_b_input_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_b_input')\n",
    "    response_b_segment_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_b_segment_ids')\n",
    "    response_b_padding_mask = keras.Input(shape=(512,), dtype=tf.int32, name='response_b_padding_mask')\n",
    "\n",
    "    # Load BERT encoder\n",
    "    encoder = keras_nlp.models.BertBackbone.from_preset('bert_small_en_uncased')\n",
    "    encoder.trainable = True  # Allow fine-tuning\n",
    "\n",
    "    # Encode inputs\n",
    "    prompt_encoded = encoder({\n",
    "        'token_ids': prompt_input_ids,\n",
    "        'segment_ids': prompt_segment_ids,\n",
    "        'padding_mask': prompt_padding_mask\n",
    "    })['sequence_output']\n",
    "    response_a_encoded = encoder({\n",
    "        'token_ids': response_a_input_ids,\n",
    "        'segment_ids': response_a_segment_ids,\n",
    "        'padding_mask': response_a_padding_mask\n",
    "    })['sequence_output']\n",
    "    response_b_encoded = encoder({\n",
    "        'token_ids': response_b_input_ids,\n",
    "        'segment_ids': response_b_segment_ids,\n",
    "        'padding_mask': response_b_padding_mask\n",
    "    })['sequence_output']\n",
    "    \n",
    "    # Attention on prompt and response_a\n",
    "    attention_a = keras.layers.Attention()([prompt_encoded, response_a_encoded])\n",
    "    attention_a = keras.layers.GlobalAveragePooling1D()(attention_a) \n",
    "    # Attention on prompt and response_b\n",
    "    attention_b = keras.layers.Attention()([prompt_encoded, response_b_encoded])\n",
    "    attention_b = keras.layers.GlobalAveragePooling1D()(attention_b)\n",
    "\n",
    "    # Combine attentions\n",
    "    combined_attention = keras.layers.Concatenate(axis=-1)([attention_a, attention_b])\n",
    "\n",
    "    # Output layers\n",
    "    # x = keras.layers.GlobalAveragePooling1D()(combined_attention)\n",
    "    x = keras.layers.Dense(32, activation='relu')(combined_attention)\n",
    "    # x = keras.layers.Dropout(0.5)(x)  # Add dropout for regularization\n",
    "    outputs = keras.layers.Dense(3, activation='softmax')(x)\n",
    "\n",
    "    # Create and compile model\n",
    "    model = keras.Model(\n",
    "        inputs=[\n",
    "            prompt_input_ids, prompt_segment_ids, prompt_padding_mask,\n",
    "            response_a_input_ids, response_a_segment_ids, response_a_padding_mask,\n",
    "            response_b_input_ids, response_b_segment_ids, response_b_padding_mask\n",
    "        ],\n",
    "        outputs=outputs\n",
    "    )\n",
    "    model.compile(\n",
    "        optimizer=keras.optimizers.Adam(learning_rate=1e-3),  # Adjusted learning rate\n",
    "        loss=keras.losses.CategoricalCrossentropy(),\n",
    "        metrics=[\"accuracy\"],\n",
    "    )\n",
    "\n",
    "    model.summary()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "c6cb9973",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:50.558500Z",
     "iopub.status.busy": "2024-08-05T01:48:50.558214Z",
     "iopub.status.idle": "2024-08-05T01:48:50.561773Z",
     "shell.execute_reply": "2024-08-05T01:48:50.560995Z"
    },
    "papermill": {
     "duration": 0.014712,
     "end_time": "2024-08-05T01:48:50.563431",
     "exception": false,
     "start_time": "2024-08-05T01:48:50.548719",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# !pip install -q pydot\n",
    "# from tensorflow.keras.utils import plot_model\n",
    "\n",
    "# # Plot the model\n",
    "# plot_model(model, to_file='model_plot.png', show_shapes=True, show_layer_names=True)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f2bb2e04",
   "metadata": {
    "papermill": {
     "duration": 0.00742,
     "end_time": "2024-08-05T01:48:50.578663",
     "exception": false,
     "start_time": "2024-08-05T01:48:50.571243",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Training"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "a2ce60e5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:48:50.595906Z",
     "iopub.status.busy": "2024-08-05T01:48:50.595416Z",
     "iopub.status.idle": "2024-08-05T02:03:13.376068Z",
     "shell.execute_reply": "2024-08-05T02:03:13.374948Z"
    },
    "papermill": {
     "duration": 862.791704,
     "end_time": "2024-08-05T02:03:13.378299",
     "exception": false,
     "start_time": "2024-08-05T01:48:50.586595",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.10/site-packages/keras/src/optimizers/base_optimizer.py:664: UserWarning: Gradients do not exist for variables ['kernel', 'bias'] when minimizing the loss. If using `model.compile()`, did you forget to provide a `loss` argument?\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2024-08-05 01:49:29.317725: E tensorflow/core/grappler/optimizers/meta_optimizer.cc:961] model_pruner failed: INVALID_ARGUMENT: Graph does not contain terminal node StatefulPartitionedCall.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822573.125373     907 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(11feaa8e96e83154:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822590.759471     907 tpu_compile_op_common.cc:245] Compilation of 11feaa8e96e83154:0:0 with session name  took 17.633896293s and succeeded\n",
      "I0000 00:00:1722822590.838542     907 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(11feaa8e96e83154:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_6212108580886331120\", property.function_library_fingerprint = 15740532463245447721, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"8,3,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722822590.838613     907 tpu_compilation_cache_interface.cc:541] After adding entry for key 11feaa8e96e83154:0:0 with session_name  cache is 1 entries (194344233 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822665.351615     838 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(a70f8052f4731787:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822679.700407     838 tpu_compile_op_common.cc:245] Compilation of a70f8052f4731787:0:0 with session name  took 14.348748521s and succeeded\n",
      "I0000 00:00:1722822679.777978     838 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(a70f8052f4731787:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_6212108580886331120\", property.function_library_fingerprint = 15740532463245447721, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"4,3,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722822679.778017     838 tpu_compilation_cache_interface.cc:541] After adding entry for key a70f8052f4731787:0:0 with session_name  cache is 2 entries (370585284 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2024-08-05 01:51:24.822032: E tensorflow/core/grappler/optimizers/meta_optimizer.cc:961] model_pruner failed: INVALID_ARGUMENT: Graph does not contain terminal node AssignVariableOp.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822685.618255     869 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(f31a15216694541:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822689.152660     869 tpu_compile_op_common.cc:245] Compilation of f31a15216694541:0:0 with session name  took 3.534355735s and succeeded\n",
      "I0000 00:00:1722822689.177083     869 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(f31a15216694541:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_3447813239702658168\", property.function_library_fingerprint = 3685828981908808350, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"8,3,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722822689.177111     869 tpu_compilation_cache_interface.cc:541] After adding entry for key f31a15216694541:0:0 with session_name  cache is 3 entries (410729707 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822695.976454     865 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(7392c284e424d27d:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722822699.493080     865 tpu_compile_op_common.cc:245] Compilation of 7392c284e424d27d:0:0 with session name  took 3.516593301s and succeeded\n",
      "I0000 00:00:1722822699.517151     865 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(7392c284e424d27d:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_3447813239702658168\", property.function_library_fingerprint = 3685828981908808350, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"5,3,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722822699.517183     865 tpu_compilation_cache_interface.cc:541] After adding entry for key 7392c284e424d27d:0:0 with session_name  cache is 4 entries (450097256 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    }
   ],
   "source": [
    "# Callbacks for early stopping and learning rate reduction\n",
    "early_stopping = keras.callbacks.EarlyStopping(monitor='val_loss', patience=7, restore_best_weights=True)\n",
    "reduce_lr = keras.callbacks.ReduceLROnPlateau(monitor='val_loss', factor=0.2, patience=3, min_lr=0.0)\n",
    "\n",
    "# Train the model with early stopping and learning rate reduction\n",
    "history = model.fit(train_dataset, validation_data=val_dataset, epochs=100, callbacks=[early_stopping], verbose=0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "3dee3d95",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T02:03:13.400286Z",
     "iopub.status.busy": "2024-08-05T02:03:13.399987Z",
     "iopub.status.idle": "2024-08-05T02:03:13.605189Z",
     "shell.execute_reply": "2024-08-05T02:03:13.604179Z"
    },
    "papermill": {
     "duration": 0.219929,
     "end_time": "2024-08-05T02:03:13.607004",
     "exception": false,
     "start_time": "2024-08-05T02:03:13.387075",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "image/png": "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BdOWLVti8uTJ+Prrr+Hj44OBAwdi0aJF7P9DdoV9gIioVvr06YMLFy7ghx9+wLZt2/D111/js88+w5IlS/DCCy8AACZNmoTY2Fhs2rQJW7duxVtvvYW5c+fi119/RXR09D3XoFarMXToUGzcuBFffvklrl69in379uH999+X2uj1egDAlClTMHDgwCqP06ZNG5NlZ2fnWr2+Xq9HREQEPv300yq3BwcH1+o4Da26s1miKErzn3zyCcaMGSP9eb722muYO3cu/vjjj7t2BCeyBQxARHbM19cXLi4uOHPmTKVtp0+fhkKhMPlS9/b2xvPPP4/nn38eBQUF6NOnD2bNmiUFIABo3bo1/vWvf+Ff//oXzp07h06dOuGTTz7Bd999V2UNLVq0AIBqa/Dx8YGrq6u0bsSIEfjPf/6DnTt3Ijk5GaIoSpe/AEiXkhwdHTFgwIA6fiI1a926NY4dO4b+/ftXuuxUlaouF549exYuLi7w9fUFgFp//q1btza5y80cIiIiEBERgRkzZmD//v3o2bMnlixZgnfffdesr0NkiXgJjMiOKZVKPPLII/jhhx9MblW/evUqVq9ejV69esHDwwMAcP36dZN93dzc0KZNG+n276KiIhQXF5u0ad26Ndzd3SvdIl6Rv78/OnXqhP/85z/IycmR1p84cQLbtm3Do48+atJ+wIAB8Pb2xtq1a7F27Vp07drV5BJW06ZN0bdvXyxduhQZGRmVXi87O7vmD6UGw4cPR3p6Or766qtK227dulXpDrIDBw7g6NGj0nJaWhp++OEHPPLII1AqlXX6/IcNG4Zjx45h48aNlV674pmd2sjLy0NZWZnJuoiICCgUihr/rIhsCc8AEdmB5cuX45dffqm0fuLEiXj33Xexfft29OrVC6+++iocHBywdOlSaLVafPjhh1Lb8PBw9O3bF507d4a3tzcOHz6MDRs2YPz48QAMZzb69++P4cOHIzw8HA4ODti4cSOuXr2Kp59+usb6PvroI8TExKB79+4YN26cdBu8RqPBrFmzTNo6OjriiSeewJo1a1BYWIiPP/640vEWLVqEXr16ISIiAi+++CJatWqFq1ev4sCBA7h8+TKOHTtWj08ReO6557Bu3Tq8/PLL2LVrF3r27AmdTofTp09j3bp12Lp1K7p06SK179ixIwYOHGhyGzwAzJ49W2pT28//3//+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",
      "text/plain": [
       "<Figure size 640x480 with 1 Axes>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Plot the training and validation loss\n",
    "plt.plot(history.history['loss'], label='Training Loss')\n",
    "plt.plot(history.history['val_loss'], label='Validation Loss')\n",
    "plt.title('Loss over epochs')\n",
    "plt.xlabel('Epochs')\n",
    "plt.ylabel('Loss')\n",
    "plt.legend()\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "58105c1c",
   "metadata": {
    "papermill": {
     "duration": 0.008646,
     "end_time": "2024-08-05T02:03:13.624894",
     "exception": false,
     "start_time": "2024-08-05T02:03:13.616248",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Predict"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "2528ce3d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T02:03:13.643840Z",
     "iopub.status.busy": "2024-08-05T02:03:13.643052Z",
     "iopub.status.idle": "2024-08-05T02:03:13.662125Z",
     "shell.execute_reply": "2024-08-05T02:03:13.661191Z"
    },
    "papermill": {
     "duration": 0.030664,
     "end_time": "2024-08-05T02:03:13.663975",
     "exception": false,
     "start_time": "2024-08-05T02:03:13.633311",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>prompt</th>\n",
       "      <th>response_a</th>\n",
       "      <th>response_b</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>136060</td>\n",
       "      <td>I have three oranges today, I ate an orange ye...</td>\n",
       "      <td>You have two oranges today.</td>\n",
       "      <td>You still have three oranges. Eating an orange...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>211333</td>\n",
       "      <td>You are a mediator in a heated political debat...</td>\n",
       "      <td>Thank you for sharing the details of the situa...</td>\n",
       "      <td>Mr Reddy and Ms Blue both have valid points in...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1233961</td>\n",
       "      <td>How to initialize the classification head when...</td>\n",
       "      <td>When you want to initialize the classification...</td>\n",
       "      <td>To initialize the classification head when per...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        id                                             prompt  \\\n",
       "0   136060  I have three oranges today, I ate an orange ye...   \n",
       "1   211333  You are a mediator in a heated political debat...   \n",
       "2  1233961  How to initialize the classification head when...   \n",
       "\n",
       "                                          response_a  \\\n",
       "0                        You have two oranges today.   \n",
       "1  Thank you for sharing the details of the situa...   \n",
       "2  When you want to initialize the classification...   \n",
       "\n",
       "                                          response_b  \n",
       "0  You still have three oranges. Eating an orange...  \n",
       "1  Mr Reddy and Ms Blue both have valid points in...  \n",
       "2  To initialize the classification head when per...  "
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Load Test Data\n",
    "test_df = pd.read_csv(base_dir + 'test.csv')\n",
    "\n",
    "# Parse String and Ensure all text data is encoded to UTF-8\n",
    "for col in [i for i in test_df.columns if i in ['prompt', 'response_a', 'response_b']]:\n",
    "    test_df[col] = test_df[col].map(lambda x: eval(x.replace(\"null\", \"''\"))[0])\n",
    "    test_df[col] = test_df[col].apply(lambda x: str(x).encode('utf-8', errors='ignore').decode('utf-8'))\n",
    "\n",
    "# Show Sample\n",
    "test_df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "21fcce31",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T02:03:13.682580Z",
     "iopub.status.busy": "2024-08-05T02:03:13.682307Z",
     "iopub.status.idle": "2024-08-05T02:03:16.907998Z",
     "shell.execute_reply": "2024-08-05T02:03:16.906717Z"
    },
    "papermill": {
     "duration": 3.237631,
     "end_time": "2024-08-05T02:03:16.910216",
     "exception": false,
     "start_time": "2024-08-05T02:03:13.672585",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Build Test Dataset\n",
    "test_dataset = build_dataset(\n",
    "    prompts=test_df.prompt.tolist(),\n",
    "    responses_a=test_df.response_a.tolist(),\n",
    "    responses_b=test_df.response_b.tolist(),\n",
    "    labels=None,\n",
    "    batch_size=64,\n",
    "    shuffle=False\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "7d44470b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T02:03:16.929566Z",
     "iopub.status.busy": "2024-08-05T02:03:16.929289Z",
     "iopub.status.idle": "2024-08-05T02:03:26.252708Z",
     "shell.execute_reply": "2024-08-05T02:03:26.251772Z"
    },
    "papermill": {
     "duration": 9.335279,
     "end_time": "2024-08-05T02:03:26.254582",
     "exception": false,
     "start_time": "2024-08-05T02:03:16.919303",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2024-08-05 02:03:22.350058: E tensorflow/core/grappler/optimizers/meta_optimizer.cc:961] model_pruner failed: INVALID_ARGUMENT: Graph does not contain terminal node functional_1/bert_backbone_1/embeddings_layer_norm_1/Reshape/ReadVariableOp.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722823402.916628     812 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(2c0c1945942025e7:0:0), session_name()\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\r",
      "\u001b[1m1/1\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m0s\u001b[0m 9s/step"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\r",
      "\u001b[1m1/1\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m9s\u001b[0m 9s/step\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722823406.135486     812 tpu_compile_op_common.cc:245] Compilation of 2c0c1945942025e7:0:0 with session name  took 3.2188133s and succeeded\n",
      "I0000 00:00:1722823406.158550     812 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(2c0c1945942025e7:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_data_distributed_10048679654413227853\", property.function_library_fingerprint = 3856142233146699390, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722823406.158578     812 tpu_compilation_cache_interface.cc:541] After adding entry for key 2c0c1945942025e7:0:0 with session_name  cache is 5 entries (489295497 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    }
   ],
   "source": [
    "test_pred = model.predict(test_dataset)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5d4c544b",
   "metadata": {
    "papermill": {
     "duration": 0.009323,
     "end_time": "2024-08-05T02:03:26.273803",
     "exception": false,
     "start_time": "2024-08-05T02:03:26.264480",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Submission"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "da1b2281",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T02:03:26.293250Z",
     "iopub.status.busy": "2024-08-05T02:03:26.292931Z",
     "iopub.status.idle": "2024-08-05T02:03:26.308349Z",
     "shell.execute_reply": "2024-08-05T02:03:26.307536Z"
    },
    "papermill": {
     "duration": 0.027165,
     "end_time": "2024-08-05T02:03:26.309863",
     "exception": false,
     "start_time": "2024-08-05T02:03:26.282698",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>winner_model_a</th>\n",
       "      <th>winner_model_b</th>\n",
       "      <th>winner_tie</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>136060</td>\n",
       "      <td>0.335547</td>\n",
       "      <td>0.334811</td>\n",
       "      <td>0.329641</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>211333</td>\n",
       "      <td>0.335547</td>\n",
       "      <td>0.334811</td>\n",
       "      <td>0.329641</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1233961</td>\n",
       "      <td>0.335547</td>\n",
       "      <td>0.334811</td>\n",
       "      <td>0.329641</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        id  winner_model_a  winner_model_b  winner_tie\n",
       "0   136060        0.335547        0.334811    0.329641\n",
       "1   211333        0.335547        0.334811    0.329641\n",
       "2  1233961        0.335547        0.334811    0.329641"
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "submission_df = test_df[[\"id\"]].copy()\n",
    "submission_df[['winner_model_a', 'winner_model_b', 'winner_tie']] = test_pred.tolist()\n",
    "submission_df.to_csv(\"submission.csv\", index=False)\n",
    "submission_df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "141ddf04",
   "metadata": {
    "papermill": {
     "duration": 0.009078,
     "end_time": "2024-08-05T02:03:26.328171",
     "exception": false,
     "start_time": "2024-08-05T02:03:26.319093",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "tpu1vmV38",
   "dataSources": [
    {
     "databundleVersionId": 8346466,
     "sourceId": 66631,
     "sourceType": "competition"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4675,
     "sourceId": 6054,
     "sourceType": "modelInstanceVersion"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4676,
     "sourceId": 6055,
     "sourceType": "modelInstanceVersion"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4678,
     "sourceId": 6057,
     "sourceType": "modelInstanceVersion"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4679,
     "sourceId": 6058,
     "sourceType": "modelInstanceVersion"
    }
   ],
   "dockerImageVersionId": 30746,
   "isGpuEnabled": false,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.14"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 944.108414,
   "end_time": "2024-08-05T02:03:34.949244",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2024-08-05T01:47:50.840830",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
