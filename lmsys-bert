{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "81e15ca4",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:08.222149Z",
     "iopub.status.busy": "2024-08-05T01:23:08.221478Z",
     "iopub.status.idle": "2024-08-05T01:23:25.961393Z",
     "shell.execute_reply": "2024-08-05T01:23:25.960656Z"
    },
    "papermill": {
     "duration": 17.75005,
     "end_time": "2024-08-05T01:23:25.964107",
     "exception": false,
     "start_time": "2024-08-05T01:23:08.214057",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING: Logging before InitGoogle() is written to STDERR\n",
      "E0000 00:00:1722820995.563728      77 common_lib.cc:798] Could not set metric server port: INVALID_ARGUMENT: Could not find SliceBuilder port 8471 in any of the 0 ports provided in `tpu_process_addresses`=\"local\"\n",
      "=== Source Location Trace: ===\n",
      "learning/45eac/tfrc/runtime/common_lib.cc:479\n",
      "D0805 01:23:15.571645390      77 config.cc:196]                        gRPC EXPERIMENT call_status_override_on_cancellation   OFF (default:OFF)\n",
      "D0805 01:23:15.571661256      77 config.cc:196]                        gRPC EXPERIMENT call_v3                                OFF (default:OFF)\n",
      "D0805 01:23:15.571665189      77 config.cc:196]                        gRPC EXPERIMENT canary_client_privacy                  ON  (default:ON)\n",
      "D0805 01:23:15.571668139      77 config.cc:196]                        gRPC EXPERIMENT capture_base_context                   ON  (default:ON)\n",
      "D0805 01:23:15.571670993      77 config.cc:196]                        gRPC EXPERIMENT client_idleness                        ON  (default:ON)\n",
      "D0805 01:23:15.571673687      77 config.cc:196]                        gRPC EXPERIMENT client_privacy                         ON  (default:ON)\n",
      "D0805 01:23:15.571676307      77 config.cc:196]                        gRPC EXPERIMENT dapper_request_wire_size               OFF (default:OFF)\n",
      "D0805 01:23:15.571679033      77 config.cc:196]                        gRPC EXPERIMENT empty_experiment                       OFF (default:OFF)\n",
      "D0805 01:23:15.571681573      77 config.cc:196]                        gRPC EXPERIMENT event_engine_client                    OFF (default:OFF)\n",
      "D0805 01:23:15.571684087      77 config.cc:196]                        gRPC EXPERIMENT event_engine_dns                       ON  (default:ON)\n",
      "D0805 01:23:15.571686648      77 config.cc:196]                        gRPC EXPERIMENT event_engine_listener                  ON  (default:ON)\n",
      "D0805 01:23:15.571689222      77 config.cc:196]                        gRPC EXPERIMENT free_large_allocator                   OFF (default:OFF)\n",
      "D0805 01:23:15.571691780      77 config.cc:196]                        gRPC EXPERIMENT google_no_envelope_resolver            OFF (default:OFF)\n",
      "D0805 01:23:15.571694330      77 config.cc:196]                        gRPC EXPERIMENT http2_stats_fix                        OFF (default:OFF)\n",
      "D0805 01:23:15.571696879      77 config.cc:196]                        gRPC EXPERIMENT keepalive_fix                          OFF (default:OFF)\n",
      "D0805 01:23:15.571699440      77 config.cc:196]                        gRPC EXPERIMENT keepalive_server_fix                   ON  (default:ON)\n",
      "D0805 01:23:15.571702203      77 config.cc:196]                        gRPC EXPERIMENT loas_do_not_prefer_rekey_next_protocol OFF (default:OFF)\n",
      "D0805 01:23:15.571704844      77 config.cc:196]                        gRPC EXPERIMENT loas_prod_to_cloud_prefer_pfs_ciphers  OFF (default:OFF)\n",
      "D0805 01:23:15.571707468      77 config.cc:196]                        gRPC EXPERIMENT monitoring_experiment                  ON  (default:ON)\n",
      "D0805 01:23:15.571710094      77 config.cc:196]                        gRPC EXPERIMENT multiping                              OFF (default:OFF)\n",
      "D0805 01:23:15.571712654      77 config.cc:196]                        gRPC EXPERIMENT peer_state_based_framing               OFF (default:OFF)\n",
      "D0805 01:23:15.571715235      77 config.cc:196]                        gRPC EXPERIMENT pending_queue_cap                      ON  (default:ON)\n",
      "D0805 01:23:15.571717909      77 config.cc:196]                        gRPC EXPERIMENT pick_first_happy_eyeballs              ON  (default:ON)\n",
      "D0805 01:23:15.571720502      77 config.cc:196]                        gRPC EXPERIMENT promise_based_client_call              OFF (default:OFF)\n",
      "D0805 01:23:15.571722993      77 config.cc:196]                        gRPC EXPERIMENT promise_based_inproc_transport         OFF (default:OFF)\n",
      "D0805 01:23:15.571725498      77 config.cc:196]                        gRPC EXPERIMENT promise_based_server_call              OFF (default:OFF)\n",
      "D0805 01:23:15.571728073      77 config.cc:196]                        gRPC EXPERIMENT registered_method_lookup_in_transport  ON  (default:ON)\n",
      "D0805 01:23:15.571730654      77 config.cc:196]                        gRPC EXPERIMENT rfc_max_concurrent_streams             ON  (default:ON)\n",
      "D0805 01:23:15.571733367      77 config.cc:196]                        gRPC EXPERIMENT round_robin_delegate_to_pick_first     ON  (default:ON)\n",
      "D0805 01:23:15.571737210      77 config.cc:196]                        gRPC EXPERIMENT rstpit                                 OFF (default:OFF)\n",
      "D0805 01:23:15.571739965      77 config.cc:196]                        gRPC EXPERIMENT schedule_cancellation_over_write       OFF (default:OFF)\n",
      "D0805 01:23:15.571742689      77 config.cc:196]                        gRPC EXPERIMENT server_privacy                         ON  (default:ON)\n",
      "D0805 01:23:15.571745473      77 config.cc:196]                        gRPC EXPERIMENT tcp_frame_size_tuning                  OFF (default:OFF)\n",
      "D0805 01:23:15.571748022      77 config.cc:196]                        gRPC EXPERIMENT tcp_rcv_lowat                          OFF (default:OFF)\n",
      "D0805 01:23:15.571750575      77 config.cc:196]                        gRPC EXPERIMENT trace_record_callops                   OFF (default:OFF)\n",
      "D0805 01:23:15.571753115      77 config.cc:196]                        gRPC EXPERIMENT unconstrained_max_quota_buffer_size    OFF (default:OFF)\n",
      "D0805 01:23:15.571755590      77 config.cc:196]                        gRPC EXPERIMENT v3_backend_metric_filter               OFF (default:OFF)\n",
      "D0805 01:23:15.571758092      77 config.cc:196]                        gRPC EXPERIMENT v3_channel_idle_filters                ON  (default:ON)\n",
      "D0805 01:23:15.571760704      77 config.cc:196]                        gRPC EXPERIMENT v3_compression_filter                  ON  (default:ON)\n",
      "D0805 01:23:15.571763290      77 config.cc:196]                        gRPC EXPERIMENT v3_server_auth_filter                  OFF (default:OFF)\n",
      "D0805 01:23:15.571765787      77 config.cc:196]                        gRPC EXPERIMENT work_serializer_clears_time_cache      OFF (default:OFF)\n",
      "D0805 01:23:15.571768269      77 config.cc:196]                        gRPC EXPERIMENT work_serializer_dispatch               OFF (default:OFF)\n",
      "D0805 01:23:15.571770798      77 config.cc:196]                        gRPC EXPERIMENT write_size_cap                         ON  (default:ON)\n",
      "D0805 01:23:15.571773415      77 config.cc:196]                        gRPC EXPERIMENT write_size_policy                      ON  (default:ON)\n",
      "D0805 01:23:15.571776059      77 config.cc:196]                        gRPC EXPERIMENT wrr_delegate_to_pick_first             ON  (default:ON)\n",
      "I0805 01:23:15.572009036      77 ev_epoll1_linux.cc:123]               grpc epoll fd: 56\n",
      "D0805 01:23:15.572023633      77 ev_posix.cc:113]                      Using polling engine: epoll1\n",
      "D0805 01:23:15.584234350      77 lb_policy_registry.cc:46]             registering LB policy factory for \"priority_experimental\"\n",
      "D0805 01:23:15.584244157      77 lb_policy_registry.cc:46]             registering LB policy factory for \"outlier_detection_experimental\"\n",
      "D0805 01:23:15.584251940      77 lb_policy_registry.cc:46]             registering LB policy factory for \"weighted_target_experimental\"\n",
      "D0805 01:23:15.584255337      77 lb_policy_registry.cc:46]             registering LB policy factory for \"pick_first\"\n",
      "D0805 01:23:15.584258210      77 lb_policy_registry.cc:46]             registering LB policy factory for \"round_robin\"\n",
      "D0805 01:23:15.584260995      77 lb_policy_registry.cc:46]             registering LB policy factory for \"weighted_round_robin\"\n",
      "D0805 01:23:15.584285552      77 lb_policy_registry.cc:46]             registering LB policy factory for \"grpclb\"\n",
      "D0805 01:23:15.584300032      77 dns_resolver_plugin.cc:43]            Using EventEngine dns resolver\n",
      "D0805 01:23:15.584315569      77 lb_policy_registry.cc:46]             registering LB policy factory for \"rls_experimental\"\n",
      "D0805 01:23:15.584338882      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_cluster_manager_experimental\"\n",
      "D0805 01:23:15.584345846      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_cluster_impl_experimental\"\n",
      "D0805 01:23:15.584348919      77 lb_policy_registry.cc:46]             registering LB policy factory for \"cds_experimental\"\n",
      "D0805 01:23:15.584352852      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_override_host_experimental\"\n",
      "D0805 01:23:15.584355962      77 lb_policy_registry.cc:46]             registering LB policy factory for \"xds_wrr_locality_experimental\"\n",
      "D0805 01:23:15.584359343      77 lb_policy_registry.cc:46]             registering LB policy factory for \"ring_hash_experimental\"\n",
      "D0805 01:23:15.584362422      77 certificate_provider_registry.cc:33]  registering certificate provider factory for \"file_watcher\"\n",
      "D0805 01:23:15.584391550      77 channel_init.cc:157]                  Filter server-auth not registered, but is referenced in the after clause of grpc-server-authz when building channel stack SERVER_CHANNEL\n",
      "I0805 01:23:15.585887634      77 ev_epoll1_linux.cc:359]               grpc epoll fd: 58\n",
      "I0805 01:23:15.586944807      77 tcp_socket_utils.cc:689]              Disabling AF_INET6 sockets because ::1 is not available.\n",
      "I0805 01:23:15.590673189     177 socket_utils_common_posix.cc:452]     Disabling AF_INET6 sockets because ::1 is not available.\n",
      "I0805 01:23:15.590723491     177 socket_utils_common_posix.cc:379]     TCP_USER_TIMEOUT is available. TCP_USER_TIMEOUT will be used thereafter\n",
      "E0805 01:23:15.596699181      77 oauth2_credentials.cc:238]            oauth_fetch: UNKNOWN:C-ares status is not ARES_SUCCESS qtype=A name=metadata.google.internal. is_balancer=0: Domain name not found {grpc_status:2, created_time:\"2024-08-05T01:23:15.59668318+00:00\"}\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.10/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html\n",
      "  from .autonotebook import tqdm as notebook_tqdm\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import keras\n",
    "import keras_nlp\n",
    "import tensorflow as tf\n",
    "from sklearn.model_selection import train_test_split\n",
    "from matplotlib import pyplot as plt"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cdd6a54f",
   "metadata": {
    "papermill": {
     "duration": 0.004407,
     "end_time": "2024-08-05T01:23:25.973262",
     "exception": false,
     "start_time": "2024-08-05T01:23:25.968855",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Load Train Data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "38747c28",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:25.983438Z",
     "iopub.status.busy": "2024-08-05T01:23:25.982927Z",
     "iopub.status.idle": "2024-08-05T01:23:33.393498Z",
     "shell.execute_reply": "2024-08-05T01:23:33.392712Z"
    },
    "papermill": {
     "duration": 7.417919,
     "end_time": "2024-08-05T01:23:33.395456",
     "exception": false,
     "start_time": "2024-08-05T01:23:25.977537",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>model_a</th>\n",
       "      <th>model_b</th>\n",
       "      <th>prompt</th>\n",
       "      <th>response_a</th>\n",
       "      <th>response_b</th>\n",
       "      <th>winner_model_a</th>\n",
       "      <th>winner_model_b</th>\n",
       "      <th>winner_tie</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>30192</td>\n",
       "      <td>gpt-4-1106-preview</td>\n",
       "      <td>gpt-4-0613</td>\n",
       "      <td>Is it morally right to try to have a certain p...</td>\n",
       "      <td>The question of whether it is morally right to...</td>\n",
       "      <td>As an AI, I don't have personal beliefs or opi...</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>53567</td>\n",
       "      <td>koala-13b</td>\n",
       "      <td>gpt-4-0613</td>\n",
       "      <td>What is the difference between marriage licens...</td>\n",
       "      <td>A marriage license is a legal document that al...</td>\n",
       "      <td>A marriage license and a marriage certificate ...</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>65089</td>\n",
       "      <td>gpt-3.5-turbo-0613</td>\n",
       "      <td>mistral-medium</td>\n",
       "      <td>explain function calling. how would you call a...</td>\n",
       "      <td>Function calling is the process of invoking or...</td>\n",
       "      <td>Function calling is the process of invoking a ...</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>96401</td>\n",
       "      <td>llama-2-13b-chat</td>\n",
       "      <td>mistral-7b-instruct</td>\n",
       "      <td>How can I create a test set for a very rare ca...</td>\n",
       "      <td>Creating a test set for a very rare category c...</td>\n",
       "      <td>When building a classifier for a very rare cat...</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>198779</td>\n",
       "      <td>koala-13b</td>\n",
       "      <td>gpt-3.5-turbo-0314</td>\n",
       "      <td>What is the best way to travel from Tel-Aviv t...</td>\n",
       "      <td>The best way to travel from Tel Aviv to Jerusa...</td>\n",
       "      <td>The best way to travel from Tel-Aviv to Jerusa...</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       id             model_a              model_b  \\\n",
       "0   30192  gpt-4-1106-preview           gpt-4-0613   \n",
       "1   53567           koala-13b           gpt-4-0613   \n",
       "2   65089  gpt-3.5-turbo-0613       mistral-medium   \n",
       "3   96401    llama-2-13b-chat  mistral-7b-instruct   \n",
       "4  198779           koala-13b   gpt-3.5-turbo-0314   \n",
       "\n",
       "                                              prompt  \\\n",
       "0  Is it morally right to try to have a certain p...   \n",
       "1  What is the difference between marriage licens...   \n",
       "2  explain function calling. how would you call a...   \n",
       "3  How can I create a test set for a very rare ca...   \n",
       "4  What is the best way to travel from Tel-Aviv t...   \n",
       "\n",
       "                                          response_a  \\\n",
       "0  The question of whether it is morally right to...   \n",
       "1  A marriage license is a legal document that al...   \n",
       "2  Function calling is the process of invoking or...   \n",
       "3  Creating a test set for a very rare category c...   \n",
       "4  The best way to travel from Tel Aviv to Jerusa...   \n",
       "\n",
       "                                          response_b  winner_model_a  \\\n",
       "0  As an AI, I don't have personal beliefs or opi...               1   \n",
       "1  A marriage license and a marriage certificate ...               0   \n",
       "2  Function calling is the process of invoking a ...               0   \n",
       "3  When building a classifier for a very rare cat...               1   \n",
       "4  The best way to travel from Tel-Aviv to Jerusa...               0   \n",
       "\n",
       "   winner_model_b  winner_tie  \n",
       "0               0           0  \n",
       "1               1           0  \n",
       "2               0           1  \n",
       "3               0           0  \n",
       "4               1           0  "
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Load Kaggle Base Folder\n",
    "base_dir = '/kaggle/input/lmsys-chatbot-arena/'\n",
    "\n",
    "# Load Train Data\n",
    "df = pd.read_csv(base_dir + 'train.csv')\n",
    "\n",
    "# Parse String and Ensure all text data is encoded to UTF-8\n",
    "for col in [i for i in df.columns if i in ['prompt', 'response_a', 'response_b']]:\n",
    "    df[col] = df[col].map(lambda x: eval(x.replace(\"null\", \"''\"))[0])\n",
    "    df[col] = df[col].apply(lambda x: str(x).encode('utf-8', errors='ignore').decode('utf-8'))\n",
    "\n",
    "# Show Sample\n",
    "df.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4ed25402",
   "metadata": {
    "papermill": {
     "duration": 0.004701,
     "end_time": "2024-08-05T01:23:33.404933",
     "exception": false,
     "start_time": "2024-08-05T01:23:33.400232",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Create Label"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "dc557ae2",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:33.415052Z",
     "iopub.status.busy": "2024-08-05T01:23:33.414736Z",
     "iopub.status.idle": "2024-08-05T01:23:33.430282Z",
     "shell.execute_reply": "2024-08-05T01:23:33.429639Z"
    },
    "papermill": {
     "duration": 0.022675,
     "end_time": "2024-08-05T01:23:33.431880",
     "exception": false,
     "start_time": "2024-08-05T01:23:33.409205",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Create label dictionary for mapping\n",
    "label_map = {'winner_model_a': 0, 'winner_model_b': 1, 'winner_tie': 2}\n",
    "\n",
    "# Map column into label\n",
    "df['label'] = df[['winner_model_a', 'winner_model_b', 'winner_tie']].idxmax(axis=1).map(label_map)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "069db8ee",
   "metadata": {
    "papermill": {
     "duration": 0.004203,
     "end_time": "2024-08-05T01:23:33.440674",
     "exception": false,
     "start_time": "2024-08-05T01:23:33.436471",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Tokenizer & Preprocessor"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "092e0a88",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:33.450712Z",
     "iopub.status.busy": "2024-08-05T01:23:33.450483Z",
     "iopub.status.idle": "2024-08-05T01:23:43.041271Z",
     "shell.execute_reply": "2024-08-05T01:23:43.040400Z"
    },
    "papermill": {
     "duration": 9.59811,
     "end_time": "2024-08-05T01:23:43.043418",
     "exception": false,
     "start_time": "2024-08-05T01:23:33.445308",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors.index.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'tokenizer.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'tokenizer.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'assets/tokenizer/vocabulary.txt' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING: All log messages before absl::InitializeLog() is called are written to STDERR\n",
      "I0000 00:00:1722821022.973924      77 service.cc:145] XLA service 0x57b09ce77970 initialized for platform TPU (this does not guarantee that XLA will be used). Devices:\n",
      "I0000 00:00:1722821022.974009      77 service.cc:153]   StreamExecutor device (0): TPU, 2a886c8\n",
      "I0000 00:00:1722821022.974013      77 service.cc:153]   StreamExecutor device (1): TPU, 2a886c8\n",
      "I0000 00:00:1722821022.974016      77 service.cc:153]   StreamExecutor device (2): TPU, 2a886c8\n",
      "I0000 00:00:1722821022.974019      77 service.cc:153]   StreamExecutor device (3): TPU, 2a886c8\n",
      "I0000 00:00:1722821022.974021      77 service.cc:153]   StreamExecutor device (4): TPU, 2a886c8\n",
      "I0000 00:00:1722821022.974024      77 service.cc:153]   StreamExecutor device (5): TPU, 2a886c8\n",
      "I0000 00:00:1722821022.974027      77 service.cc:153]   StreamExecutor device (6): TPU, 2a886c8\n",
      "I0000 00:00:1722821022.974030      77 service.cc:153]   StreamExecutor device (7): TPU, 2a886c8\n"
     ]
    }
   ],
   "source": [
    "tokenizer = keras_nlp.models.BertTokenizer.from_preset(\n",
    "    \"bert_small_en_uncased\",\n",
    ")\n",
    "\n",
    "preprocessor = keras_nlp.models.BertPreprocessor(\n",
    "    tokenizer=tokenizer,\n",
    "    sequence_length=512\n",
    ")\n",
    "\n",
    "# Update preprocess_fn to handle multiple inputs and return additional features\n",
    "def preprocess_fn(prompt, response_a, response_b, label=None):\n",
    "    prompt = preprocessor(prompt)\n",
    "    response_a = preprocessor(response_a)\n",
    "    response_b = preprocessor(response_b)\n",
    "    inputs = {\n",
    "        'prompt_input': prompt['token_ids'],\n",
    "        'prompt_segment_ids': prompt['segment_ids'],\n",
    "        'prompt_padding_mask': prompt['padding_mask'],\n",
    "        'response_a_input': response_a['token_ids'],\n",
    "        'response_a_segment_ids': response_a['segment_ids'],\n",
    "        'response_a_padding_mask': response_a['padding_mask'],\n",
    "        'response_b_input': response_b['token_ids'],\n",
    "        'response_b_segment_ids': response_b['segment_ids'],\n",
    "        'response_b_padding_mask': response_b['padding_mask'],\n",
    "    }\n",
    "    return (inputs, label) if label is not None else inputs\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0538cbae",
   "metadata": {
    "papermill": {
     "duration": 0.005276,
     "end_time": "2024-08-05T01:23:43.054585",
     "exception": false,
     "start_time": "2024-08-05T01:23:43.049309",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Build Dataset"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "6bea702d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:43.066522Z",
     "iopub.status.busy": "2024-08-05T01:23:43.065861Z",
     "iopub.status.idle": "2024-08-05T01:23:43.070635Z",
     "shell.execute_reply": "2024-08-05T01:23:43.070014Z"
    },
    "papermill": {
     "duration": 0.012646,
     "end_time": "2024-08-05T01:23:43.072275",
     "exception": false,
     "start_time": "2024-08-05T01:23:43.059629",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Update build_dataset function\n",
    "def build_dataset(prompts, responses_a, responses_b, labels=None, batch_size=16, shuffle=True):\n",
    "    slices = (prompts, responses_a, responses_b, keras.utils.to_categorical(labels, num_classes=3)) if labels is not None else (prompts, responses_a, responses_b)\n",
    "    ds = tf.data.Dataset.from_tensor_slices(slices)\n",
    "    ds = ds.map(preprocess_fn, num_parallel_calls=tf.data.AUTOTUNE)\n",
    "    if shuffle:\n",
    "        ds = ds.shuffle(buffer_size=10000)\n",
    "    ds = ds.batch(batch_size)\n",
    "    ds = ds.prefetch(tf.data.AUTOTUNE)\n",
    "    return ds"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "19a03ed4",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:43.083577Z",
     "iopub.status.busy": "2024-08-05T01:23:43.083346Z",
     "iopub.status.idle": "2024-08-05T01:23:49.690870Z",
     "shell.execute_reply": "2024-08-05T01:23:49.690032Z"
    },
    "papermill": {
     "duration": 6.616083,
     "end_time": "2024-08-05T01:23:49.693457",
     "exception": false,
     "start_time": "2024-08-05T01:23:43.077374",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "train_df, val_df = train_test_split(df, test_size=0.2, stratify=df.label)\n",
    "\n",
    "# Build the datasets\n",
    "train_dataset = build_dataset(\n",
    "    prompts=train_df.prompt.tolist(),\n",
    "    responses_a=train_df.response_a.tolist(),\n",
    "    responses_b=train_df.response_b.tolist(),\n",
    "    labels=train_df.label.tolist(),\n",
    "    batch_size=64,\n",
    "    shuffle=True\n",
    ")\n",
    "\n",
    "val_dataset = build_dataset(\n",
    "    prompts=val_df.prompt.tolist(),\n",
    "    responses_a=val_df.response_a.tolist(),\n",
    "    responses_b=val_df.response_b.tolist(),\n",
    "    labels=val_df.label.tolist(),\n",
    "    batch_size=64,\n",
    "    shuffle=False\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "87836899",
   "metadata": {
    "papermill": {
     "duration": 0.004926,
     "end_time": "2024-08-05T01:23:49.703850",
     "exception": false,
     "start_time": "2024-08-05T01:23:49.698924",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Modeling"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "5eef9354",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:49.715304Z",
     "iopub.status.busy": "2024-08-05T01:23:49.715013Z",
     "iopub.status.idle": "2024-08-05T01:23:54.276365Z",
     "shell.execute_reply": "2024-08-05T01:23:54.275471Z"
    },
    "papermill": {
     "duration": 4.576502,
     "end_time": "2024-08-05T01:23:54.285496",
     "exception": false,
     "start_time": "2024-08-05T01:23:49.708994",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Deallocate tpu buffers before initializing tpu system.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Initializing the TPU system: local\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Finished initializing TPU system.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "WARNING:absl:`tf.distribute.experimental.TPUStrategy` is deprecated, please use the non-experimental symbol `tf.distribute.TPUStrategy` instead.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Found TPU system:\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:Found TPU system:\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores: 8\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores: 8\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Workers: 1\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Workers: 1\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores Per Worker: 8\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Num TPU Cores Per Worker: 8\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:CPU:0, CPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:CPU:0, CPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:0, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:0, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:1, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:1, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:2, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:2, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:3, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:3, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:4, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:4, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:5, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:5, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:6, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:6, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:7, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU:7, TPU, 0, 0)\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU_SYSTEM:0, TPU_SYSTEM, 0, 0)\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "INFO:tensorflow:*** Available Device: _DeviceAttributes(/job:localhost/replica:0/task:0/device:TPU_SYSTEM:0, TPU_SYSTEM, 0, 0)\n"
     ]
    }
   ],
   "source": [
    "try:\n",
    "    tpu = tf.distribute.cluster_resolver.TPUClusterResolver()\n",
    "    tf.config.experimental_connect_to_cluster(tpu)\n",
    "    tf.tpu.experimental.initialize_tpu_system(tpu)\n",
    "    tpu_strategy = tf.distribute.experimental.TPUStrategy(tpu)\n",
    "except ValueError:\n",
    "    tpu_strategy = tf.distribute.get_strategy()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2f7f7342",
   "metadata": {
    "papermill": {
     "duration": 0.008643,
     "end_time": "2024-08-05T01:23:54.303872",
     "exception": false,
     "start_time": "2024-08-05T01:23:54.295229",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Train"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "c1ad0f49",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:23:54.322769Z",
     "iopub.status.busy": "2024-08-05T01:23:54.322495Z",
     "iopub.status.idle": "2024-08-05T01:24:03.629685Z",
     "shell.execute_reply": "2024-08-05T01:24:03.628903Z"
    },
    "papermill": {
     "duration": 9.318647,
     "end_time": "2024-08-05T01:24:03.631374",
     "exception": false,
     "start_time": "2024-08-05T01:23:54.312727",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.safetensors.index.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'metadata.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'config.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'config.json' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Attaching 'model.weights.h5' from model 'keras/bert/keras/bert_small_en_uncased/2' to your Kaggle notebook...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821043.213120      77 device_compiler.h:188] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">Model: \"functional\"</span>\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1mModel: \"functional\"\u001b[0m\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓\n",
       "┃<span style=\"font-weight: bold\"> Layer (type)        </span>┃<span style=\"font-weight: bold\"> Output Shape      </span>┃<span style=\"font-weight: bold\">    Param # </span>┃<span style=\"font-weight: bold\"> Connected to      </span>┃\n",
       "┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩\n",
       "│ prompt_padding_mask │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_segment_ids  │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_input        │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_padding… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_segment… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_input    │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_padding… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_segment… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_input    │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ -                 │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">InputLayer</span>)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ bert_backbone       │ [(<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>),     │ <span style=\"color: #00af00; text-decoration-color: #00af00\">28,763,648</span> │ prompt_padding_m… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">BertBackbone</span>)      │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)] │            │ prompt_segment_i… │\n",
       "│                     │                   │            │ prompt_input[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">…</span> │\n",
       "│                     │                   │            │ response_a_paddi… │\n",
       "│                     │                   │            │ response_a_segme… │\n",
       "│                     │                   │            │ response_a_input… │\n",
       "│                     │                   │            │ response_b_paddi… │\n",
       "│                     │                   │            │ response_b_segme… │\n",
       "│                     │                   │            │ response_b_input… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention           │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)  │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Attention</span>)         │                   │            │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">1</span>]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention_1         │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)  │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Attention</span>)         │                   │            │ bert_backbone[<span style=\"color: #00af00; text-decoration-color: #00af00\">2</span>]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ attention[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]   │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">GlobalAveragePool…</span> │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">512</span>)       │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ attention_1[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>] │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">GlobalAveragePool…</span> │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ concatenate         │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">1024</span>)      │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ global_average_p… │\n",
       "│ (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Concatenate</span>)       │                   │            │ global_average_p… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Dense</span>)       │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">32</span>)        │     <span style=\"color: #00af00; text-decoration-color: #00af00\">32,800</span> │ concatenate[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>] │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dropout_4 (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Dropout</span>) │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">32</span>)        │          <span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> │ dense[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]       │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense_1 (<span style=\"color: #0087ff; text-decoration-color: #0087ff\">Dense</span>)     │ (<span style=\"color: #00d7ff; text-decoration-color: #00d7ff\">None</span>, <span style=\"color: #00af00; text-decoration-color: #00af00\">3</span>)         │         <span style=\"color: #00af00; text-decoration-color: #00af00\">99</span> │ dropout_4[<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>][<span style=\"color: #00af00; text-decoration-color: #00af00\">0</span>]   │\n",
       "└─────────────────────┴───────────────────┴────────────┴───────────────────┘\n",
       "</pre>\n"
      ],
      "text/plain": [
       "┏━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓\n",
       "┃\u001b[1m \u001b[0m\u001b[1mLayer (type)       \u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1mOutput Shape     \u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1m   Param #\u001b[0m\u001b[1m \u001b[0m┃\u001b[1m \u001b[0m\u001b[1mConnected to     \u001b[0m\u001b[1m \u001b[0m┃\n",
       "┡━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩\n",
       "│ prompt_padding_mask │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_segment_ids  │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ prompt_input        │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_padding… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_segment… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_a_input    │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_padding… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_segment… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ response_b_input    │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ -                 │\n",
       "│ (\u001b[38;5;33mInputLayer\u001b[0m)        │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ bert_backbone       │ [(\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m),     │ \u001b[38;5;34m28,763,648\u001b[0m │ prompt_padding_m… │\n",
       "│ (\u001b[38;5;33mBertBackbone\u001b[0m)      │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m, \u001b[38;5;34m512\u001b[0m)] │            │ prompt_segment_i… │\n",
       "│                     │                   │            │ prompt_input[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m…\u001b[0m │\n",
       "│                     │                   │            │ response_a_paddi… │\n",
       "│                     │                   │            │ response_a_segme… │\n",
       "│                     │                   │            │ response_a_input… │\n",
       "│                     │                   │            │ response_b_paddi… │\n",
       "│                     │                   │            │ response_b_segme… │\n",
       "│                     │                   │            │ response_b_input… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention           │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m, \u001b[38;5;34m512\u001b[0m)  │          \u001b[38;5;34m0\u001b[0m │ bert_backbone[\u001b[38;5;34m0\u001b[0m]… │\n",
       "│ (\u001b[38;5;33mAttention\u001b[0m)         │                   │            │ bert_backbone[\u001b[38;5;34m1\u001b[0m]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ attention_1         │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m, \u001b[38;5;34m512\u001b[0m)  │          \u001b[38;5;34m0\u001b[0m │ bert_backbone[\u001b[38;5;34m0\u001b[0m]… │\n",
       "│ (\u001b[38;5;33mAttention\u001b[0m)         │                   │            │ bert_backbone[\u001b[38;5;34m2\u001b[0m]… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ attention[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]   │\n",
       "│ (\u001b[38;5;33mGlobalAveragePool…\u001b[0m │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ global_average_poo… │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m512\u001b[0m)       │          \u001b[38;5;34m0\u001b[0m │ attention_1[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m] │\n",
       "│ (\u001b[38;5;33mGlobalAveragePool…\u001b[0m │                   │            │                   │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ concatenate         │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m1024\u001b[0m)      │          \u001b[38;5;34m0\u001b[0m │ global_average_p… │\n",
       "│ (\u001b[38;5;33mConcatenate\u001b[0m)       │                   │            │ global_average_p… │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense (\u001b[38;5;33mDense\u001b[0m)       │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m32\u001b[0m)        │     \u001b[38;5;34m32,800\u001b[0m │ concatenate[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m] │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dropout_4 (\u001b[38;5;33mDropout\u001b[0m) │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m32\u001b[0m)        │          \u001b[38;5;34m0\u001b[0m │ dense[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]       │\n",
       "├─────────────────────┼───────────────────┼────────────┼───────────────────┤\n",
       "│ dense_1 (\u001b[38;5;33mDense\u001b[0m)     │ (\u001b[38;5;45mNone\u001b[0m, \u001b[38;5;34m3\u001b[0m)         │         \u001b[38;5;34m99\u001b[0m │ dropout_4[\u001b[38;5;34m0\u001b[0m][\u001b[38;5;34m0\u001b[0m]   │\n",
       "└─────────────────────┴───────────────────┴────────────┴───────────────────┘\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Total params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">28,796,547</span> (109.85 MB)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Total params: \u001b[0m\u001b[38;5;34m28,796,547\u001b[0m (109.85 MB)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Trainable params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">28,796,547</span> (109.85 MB)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Trainable params: \u001b[0m\u001b[38;5;34m28,796,547\u001b[0m (109.85 MB)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\"> Non-trainable params: </span><span style=\"color: #00af00; text-decoration-color: #00af00\">0</span> (0.00 B)\n",
       "</pre>\n"
      ],
      "text/plain": [
       "\u001b[1m Non-trainable params: \u001b[0m\u001b[38;5;34m0\u001b[0m (0.00 B)\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "with tpu_strategy.scope():\n",
    "    # Define input layers\n",
    "    prompt_input_ids = keras.Input(shape=(512,), dtype=tf.int32, name='prompt_input')\n",
    "    prompt_segment_ids = keras.Input(shape=(512,), dtype=tf.int32, name='prompt_segment_ids')\n",
    "    prompt_padding_mask = keras.Input(shape=(512,), dtype=tf.int32, name='prompt_padding_mask')\n",
    "\n",
    "    response_a_input_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_a_input')\n",
    "    response_a_segment_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_a_segment_ids')\n",
    "    response_a_padding_mask = keras.Input(shape=(512,), dtype=tf.int32, name='response_a_padding_mask')\n",
    "\n",
    "    response_b_input_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_b_input')\n",
    "    response_b_segment_ids = keras.Input(shape=(512,), dtype=tf.int32, name='response_b_segment_ids')\n",
    "    response_b_padding_mask = keras.Input(shape=(512,), dtype=tf.int32, name='response_b_padding_mask')\n",
    "\n",
    "    # Load BERT encoder\n",
    "    encoder = keras_nlp.models.BertBackbone.from_preset('bert_small_en_uncased')\n",
    "    encoder.trainable = True  # Allow fine-tuning\n",
    "\n",
    "    # Encode inputs\n",
    "    prompt_encoded = encoder({\n",
    "        'token_ids': prompt_input_ids,\n",
    "        'segment_ids': prompt_segment_ids,\n",
    "        'padding_mask': prompt_padding_mask\n",
    "    })['sequence_output']\n",
    "    response_a_encoded = encoder({\n",
    "        'token_ids': response_a_input_ids,\n",
    "        'segment_ids': response_a_segment_ids,\n",
    "        'padding_mask': response_a_padding_mask\n",
    "    })['sequence_output']\n",
    "    response_b_encoded = encoder({\n",
    "        'token_ids': response_b_input_ids,\n",
    "        'segment_ids': response_b_segment_ids,\n",
    "        'padding_mask': response_b_padding_mask\n",
    "    })['sequence_output']\n",
    "    \n",
    "    # Attention on prompt and response_a\n",
    "    attention_a = keras.layers.Attention()([prompt_encoded, response_a_encoded])\n",
    "    attention_a = keras.layers.GlobalAveragePooling1D()(attention_a) \n",
    "    # Attention on prompt and response_b\n",
    "    attention_b = keras.layers.Attention()([prompt_encoded, response_b_encoded])\n",
    "    attention_b = keras.layers.GlobalAveragePooling1D()(attention_b)\n",
    "\n",
    "    # Combine attentions\n",
    "    combined_attention = keras.layers.Concatenate(axis=-1)([attention_a, attention_b])\n",
    "\n",
    "    # Output layers\n",
    "    # x = keras.layers.GlobalAveragePooling1D()(combined_attention)\n",
    "    x = keras.layers.Dense(32, activation='relu')(combined_attention)\n",
    "    x = keras.layers.Dropout(0.5)(x)  # Add dropout for regularization\n",
    "    outputs = keras.layers.Dense(3, activation='softmax')(x)\n",
    "\n",
    "    # Create and compile model\n",
    "    model = keras.Model(\n",
    "        inputs=[\n",
    "            prompt_input_ids, prompt_segment_ids, prompt_padding_mask,\n",
    "            response_a_input_ids, response_a_segment_ids, response_a_padding_mask,\n",
    "            response_b_input_ids, response_b_segment_ids, response_b_padding_mask\n",
    "        ],\n",
    "        outputs=outputs\n",
    "    )\n",
    "    model.compile(\n",
    "        optimizer=keras.optimizers.Adam(learning_rate=1e-3),  # Adjusted learning rate\n",
    "        loss=keras.losses.CategoricalCrossentropy(),\n",
    "        metrics=[\"accuracy\"],\n",
    "    )\n",
    "\n",
    "    model.summary()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "d67ada27",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:24:03.648798Z",
     "iopub.status.busy": "2024-08-05T01:24:03.648541Z",
     "iopub.status.idle": "2024-08-05T01:24:03.651663Z",
     "shell.execute_reply": "2024-08-05T01:24:03.651010Z"
    },
    "papermill": {
     "duration": 0.013548,
     "end_time": "2024-08-05T01:24:03.653263",
     "exception": false,
     "start_time": "2024-08-05T01:24:03.639715",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# !pip install -q pydot\n",
    "# from tensorflow.keras.utils import plot_model\n",
    "\n",
    "# # Plot the model\n",
    "# plot_model(model, to_file='model_plot.png', show_shapes=True, show_layer_names=True)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a1e4f1b5",
   "metadata": {
    "papermill": {
     "duration": 0.007688,
     "end_time": "2024-08-05T01:24:03.668783",
     "exception": false,
     "start_time": "2024-08-05T01:24:03.661095",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Training"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "61966f06",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:24:03.684949Z",
     "iopub.status.busy": "2024-08-05T01:24:03.684720Z",
     "iopub.status.idle": "2024-08-05T01:38:27.088328Z",
     "shell.execute_reply": "2024-08-05T01:38:27.087057Z"
    },
    "papermill": {
     "duration": 863.419035,
     "end_time": "2024-08-05T01:38:27.095062",
     "exception": false,
     "start_time": "2024-08-05T01:24:03.676027",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.10/site-packages/keras/src/optimizers/base_optimizer.py:664: UserWarning: Gradients do not exist for variables ['kernel', 'bias'] when minimizing the loss. If using `model.compile()`, did you forget to provide a `loss` argument?\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2024-08-05 01:24:41.357609: E tensorflow/core/grappler/optimizers/meta_optimizer.cc:961] model_pruner failed: INVALID_ARGUMENT: Graph does not contain terminal node StatefulPartitionedCall.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821085.198449     813 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(2b29b95fbdc31c86:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821102.188877     813 tpu_compile_op_common.cc:245] Compilation of 2b29b95fbdc31c86:0:0 with session name  took 16.990372672s and succeeded\n",
      "I0000 00:00:1722821102.267497     813 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(2b29b95fbdc31c86:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_13549974065549677330\", property.function_library_fingerprint = 15869973242771218355, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"8,3,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722821102.267532     813 tpu_compilation_cache_interface.cc:541] After adding entry for key 2b29b95fbdc31c86:0:0 with session_name  cache is 1 entries (194591377 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821177.084840     820 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(d0dca13d2965e791:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821191.015731     820 tpu_compile_op_common.cc:245] Compilation of d0dca13d2965e791:0:0 with session name  took 13.930855295s and succeeded\n",
      "I0000 00:00:1722821191.090384     820 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(d0dca13d2965e791:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_13549974065549677330\", property.function_library_fingerprint = 15869973242771218355, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"4,3,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;4,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722821191.090415     820 tpu_compilation_cache_interface.cc:541] After adding entry for key d0dca13d2965e791:0:0 with session_name  cache is 2 entries (371123960 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2024-08-05 01:26:36.183947: E tensorflow/core/grappler/optimizers/meta_optimizer.cc:961] model_pruner failed: INVALID_ARGUMENT: Graph does not contain terminal node AssignVariableOp.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821196.989134     880 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(f31a15216694541:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821200.619940     880 tpu_compile_op_common.cc:245] Compilation of f31a15216694541:0:0 with session name  took 3.630754778s and succeeded\n",
      "I0000 00:00:1722821200.642391     880 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(f31a15216694541:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_3447813239702658168\", property.function_library_fingerprint = 3685828981908808350, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"8,3,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;8,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722821200.642423     880 tpu_compilation_cache_interface.cc:541] After adding entry for key f31a15216694541:0:0 with session_name  cache is 3 entries (411268383 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821207.437528     867 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(7392c284e424d27d:0:0), session_name()\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821210.871112     867 tpu_compile_op_common.cc:245] Compilation of 7392c284e424d27d:0:0 with session name  took 3.433545735s and succeeded\n",
      "I0000 00:00:1722821210.889820     867 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(7392c284e424d27d:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_iterator_3447813239702658168\", property.function_library_fingerprint = 3685828981908808350, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"5,3,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;5,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722821210.889849     867 tpu_compilation_cache_interface.cc:541] After adding entry for key 7392c284e424d27d:0:0 with session_name  cache is 4 entries (450635932 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    }
   ],
   "source": [
    "# Callbacks for early stopping and learning rate reduction\n",
    "early_stopping = keras.callbacks.EarlyStopping(monitor='val_loss', patience=7, restore_best_weights=True)\n",
    "reduce_lr = keras.callbacks.ReduceLROnPlateau(monitor='val_loss', factor=0.2, patience=3, min_lr=0.0)\n",
    "\n",
    "# Train the model with early stopping and learning rate reduction\n",
    "history = model.fit(train_dataset, validation_data=val_dataset, epochs=100, callbacks=[early_stopping], verbose=0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "53e00ec9",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:38:27.117401Z",
     "iopub.status.busy": "2024-08-05T01:38:27.117115Z",
     "iopub.status.idle": "2024-08-05T01:38:27.331250Z",
     "shell.execute_reply": "2024-08-05T01:38:27.330228Z"
    },
    "papermill": {
     "duration": 0.228562,
     "end_time": "2024-08-05T01:38:27.333422",
     "exception": false,
     "start_time": "2024-08-05T01:38:27.104860",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "image/png": "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",
      "text/plain": [
       "<Figure size 640x480 with 1 Axes>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Plot the training and validation loss\n",
    "plt.plot(history.history['loss'], label='Training Loss')\n",
    "plt.plot(history.history['val_loss'], label='Validation Loss')\n",
    "plt.title('Loss over epochs')\n",
    "plt.xlabel('Epochs')\n",
    "plt.ylabel('Loss')\n",
    "plt.legend()\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "223a136b",
   "metadata": {
    "papermill": {
     "duration": 0.008609,
     "end_time": "2024-08-05T01:38:27.351095",
     "exception": false,
     "start_time": "2024-08-05T01:38:27.342486",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Predict"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "01e6f241",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:38:27.370673Z",
     "iopub.status.busy": "2024-08-05T01:38:27.370405Z",
     "iopub.status.idle": "2024-08-05T01:38:27.388405Z",
     "shell.execute_reply": "2024-08-05T01:38:27.387563Z"
    },
    "papermill": {
     "duration": 0.0301,
     "end_time": "2024-08-05T01:38:27.390097",
     "exception": false,
     "start_time": "2024-08-05T01:38:27.359997",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>prompt</th>\n",
       "      <th>response_a</th>\n",
       "      <th>response_b</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>136060</td>\n",
       "      <td>I have three oranges today, I ate an orange ye...</td>\n",
       "      <td>You have two oranges today.</td>\n",
       "      <td>You still have three oranges. Eating an orange...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>211333</td>\n",
       "      <td>You are a mediator in a heated political debat...</td>\n",
       "      <td>Thank you for sharing the details of the situa...</td>\n",
       "      <td>Mr Reddy and Ms Blue both have valid points in...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1233961</td>\n",
       "      <td>How to initialize the classification head when...</td>\n",
       "      <td>When you want to initialize the classification...</td>\n",
       "      <td>To initialize the classification head when per...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        id                                             prompt  \\\n",
       "0   136060  I have three oranges today, I ate an orange ye...   \n",
       "1   211333  You are a mediator in a heated political debat...   \n",
       "2  1233961  How to initialize the classification head when...   \n",
       "\n",
       "                                          response_a  \\\n",
       "0                        You have two oranges today.   \n",
       "1  Thank you for sharing the details of the situa...   \n",
       "2  When you want to initialize the classification...   \n",
       "\n",
       "                                          response_b  \n",
       "0  You still have three oranges. Eating an orange...  \n",
       "1  Mr Reddy and Ms Blue both have valid points in...  \n",
       "2  To initialize the classification head when per...  "
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Load Test Data\n",
    "test_df = pd.read_csv(base_dir + 'test.csv')\n",
    "\n",
    "# Parse String and Ensure all text data is encoded to UTF-8\n",
    "for col in [i for i in test_df.columns if i in ['prompt', 'response_a', 'response_b']]:\n",
    "    test_df[col] = test_df[col].map(lambda x: eval(x.replace(\"null\", \"''\"))[0])\n",
    "    test_df[col] = test_df[col].apply(lambda x: str(x).encode('utf-8', errors='ignore').decode('utf-8'))\n",
    "\n",
    "# Show Sample\n",
    "test_df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "b6cf0658",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:38:27.409303Z",
     "iopub.status.busy": "2024-08-05T01:38:27.409057Z",
     "iopub.status.idle": "2024-08-05T01:38:29.432103Z",
     "shell.execute_reply": "2024-08-05T01:38:29.430893Z"
    },
    "papermill": {
     "duration": 2.03529,
     "end_time": "2024-08-05T01:38:29.434492",
     "exception": false,
     "start_time": "2024-08-05T01:38:27.399202",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# Build Test Dataset\n",
    "test_dataset = build_dataset(\n",
    "    prompts=test_df.prompt.tolist(),\n",
    "    responses_a=test_df.response_a.tolist(),\n",
    "    responses_b=test_df.response_b.tolist(),\n",
    "    labels=None,\n",
    "    batch_size=64,\n",
    "    shuffle=False\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "24781c5f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:38:29.454188Z",
     "iopub.status.busy": "2024-08-05T01:38:29.453655Z",
     "iopub.status.idle": "2024-08-05T01:38:39.330554Z",
     "shell.execute_reply": "2024-08-05T01:38:39.329390Z"
    },
    "papermill": {
     "duration": 9.888612,
     "end_time": "2024-08-05T01:38:39.332372",
     "exception": false,
     "start_time": "2024-08-05T01:38:29.443760",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2024-08-05 01:38:35.347120: E tensorflow/core/grappler/optimizers/meta_optimizer.cc:961] model_pruner failed: INVALID_ARGUMENT: Graph does not contain terminal node functional_1/bert_backbone_1/embeddings_layer_norm_1/Reshape/ReadVariableOp.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821915.948999     844 tpu_compilation_cache_interface.cc:441] TPU host compilation cache miss: cache_key(2c0c1945942025e7:0:0), session_name()\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\r",
      "\u001b[1m1/1\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m0s\u001b[0m 10s/step"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\r",
      "\u001b[1m1/1\u001b[0m \u001b[32m━━━━━━━━━━━━━━━━━━━━\u001b[0m\u001b[37m\u001b[0m \u001b[1m10s\u001b[0m 10s/step\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "I0000 00:00:1722821919.224766     844 tpu_compile_op_common.cc:245] Compilation of 2c0c1945942025e7:0:0 with session name  took 3.275712489s and succeeded\n",
      "I0000 00:00:1722821919.247604     844 tpu_compilation_cache_interface.cc:475] TPU host compilation cache: compilation complete for cache_key(2c0c1945942025e7:0:0), session_name(), subgraph_key(std::string(property.function_name) = \"cluster_one_step_on_data_distributed_10048679654413227853\", property.function_library_fingerprint = 3856142233146699390, property.mlir_module_fingerprint = 0, property.num_replicas = 8, topology.chip_bounds().x = 2, topology.chip_bounds().y = 2, topology.chip_bounds().z = 1, topology.wrap().x = false, topology.wrap().y = false, topology.wrap().z = false, std::string(property.shapes_prefix) = \"2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;2,512,;\", property.guaranteed_constants_size = 0, embedding_partitions_fingerprint = \"1688352644216761960\")\n",
      "I0000 00:00:1722821919.247655     844 tpu_compilation_cache_interface.cc:541] After adding entry for key 2c0c1945942025e7:0:0 with session_name  cache is 5 entries (489834173 bytes),  marked for eviction 0 entries (0 bytes).\n"
     ]
    }
   ],
   "source": [
    "test_pred = model.predict(test_dataset)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "68738fa0",
   "metadata": {
    "papermill": {
     "duration": 0.009005,
     "end_time": "2024-08-05T01:38:39.351138",
     "exception": false,
     "start_time": "2024-08-05T01:38:39.342133",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Submission"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "afa8ff41",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-08-05T01:38:39.370763Z",
     "iopub.status.busy": "2024-08-05T01:38:39.370492Z",
     "iopub.status.idle": "2024-08-05T01:38:39.384995Z",
     "shell.execute_reply": "2024-08-05T01:38:39.384009Z"
    },
    "papermill": {
     "duration": 0.026457,
     "end_time": "2024-08-05T01:38:39.386591",
     "exception": false,
     "start_time": "2024-08-05T01:38:39.360134",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>winner_model_a</th>\n",
       "      <th>winner_model_b</th>\n",
       "      <th>winner_tie</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>136060</td>\n",
       "      <td>0.353959</td>\n",
       "      <td>0.345844</td>\n",
       "      <td>0.300197</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>211333</td>\n",
       "      <td>0.353959</td>\n",
       "      <td>0.345844</td>\n",
       "      <td>0.300197</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1233961</td>\n",
       "      <td>0.353959</td>\n",
       "      <td>0.345844</td>\n",
       "      <td>0.300197</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        id  winner_model_a  winner_model_b  winner_tie\n",
       "0   136060        0.353959        0.345844    0.300197\n",
       "1   211333        0.353959        0.345844    0.300197\n",
       "2  1233961        0.353959        0.345844    0.300197"
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "submission_df = test_df[[\"id\"]].copy()\n",
    "submission_df[['winner_model_a', 'winner_model_b', 'winner_tie']] = test_pred.tolist()\n",
    "submission_df.to_csv(\"submission.csv\", index=False)\n",
    "submission_df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "45f7f3fd",
   "metadata": {
    "papermill": {
     "duration": 0.008752,
     "end_time": "2024-08-05T01:38:39.404444",
     "exception": false,
     "start_time": "2024-08-05T01:38:39.395692",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "tpu1vmV38",
   "dataSources": [
    {
     "databundleVersionId": 8346466,
     "sourceId": 66631,
     "sourceType": "competition"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4675,
     "sourceId": 6054,
     "sourceType": "modelInstanceVersion"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4676,
     "sourceId": 6055,
     "sourceType": "modelInstanceVersion"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4678,
     "sourceId": 6057,
     "sourceType": "modelInstanceVersion"
    },
    {
     "modelId": 2819,
     "modelInstanceId": 4679,
     "sourceId": 6058,
     "sourceType": "modelInstanceVersion"
    }
   ],
   "dockerImageVersionId": 30746,
   "isGpuEnabled": false,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.14"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 941.224819,
   "end_time": "2024-08-05T01:38:47.808661",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2024-08-05T01:23:06.583842",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
